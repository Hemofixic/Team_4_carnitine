---
title: "Team_4_carnitine"
author: "Ахметова Мария, Иван Валиев, Ислам Шовгенов, Козлова Ирина"
date: today
lang: ru
format:
  docx:
    toc: true
    toc-depth: 3
    number-sections: true
    highlight-style: tango
number-sections: true
execute:
    echo: true
    warning: false
    message: false
---

```{r}
library(tidyverse)
library(rstatix)
library(flextable)
library(broom)
library(officer)
library(ggplot2)
```

```{r}
data <- read.csv("data/team4_ecrf_wide.csv")
```

# Информация о переменных

Все названия переменных (столбцов) следуют единому шаблону:

-   V1\_ — измерения, проведённые на первом визите (День 1), то есть исходные, базовые показатели.
-   V2\_ — измерения, проведённые на втором визите (День 90), то есть показатели после курса терапии.
-   После префикса визита следует код домена (категории данных), например DEM (демография), SEM (спермограмма).
-   Заканчивается название конкретным параметром, например AGE (возраст), CONC (концентрация).
-   Данные хранятся в формате "один пациент — одна строка" (wide format).

**1. Идентификационные и группирующие переменные**

-   *USUBJID* — Уникальный буквенно-цифровой идентификатор пациента в исследовании.
-   *ARM* — Группа терапи, в которую был рандомизирован пациент. Принимает значения: "Placebo" (группа плацебо) или "L-carnitine" (группа активного лечения).

**2. Демографические и общие данные (измерены на Визите 1)**

Эти переменные описывают базовые характеристики пациентов и были собраны однократно при включении в исследование.

-   *V1_DEM_SEX* — Пол пациента. Все участники исследования — мужчины.
-   *V1_DEM_AGE* — Возраст пациента на момент включения в исследование, полных лет.
-   *V1_ANT_HEIGHTCM* — Рост пациента, измеренный в сантиметрах (см).
-   *V1_ANT_WEIGHTKG* — Масса тела пациента, измеренная в килограммах (кг).
-   *V1_ANT_BMI* — Индекс массы тела (ИМТ), рассчитанный как масса тела (кг) / рост² (м²).

**3. Витальные признаки и безопасность**

Показатели безопасности, оценивавшиеся на обоих визитах. Переменные имеют бинарный (0/1) формат, где 0 означает "Норма", а 1 означает "Отклонение от нормы".

Измерено на Визите 1 (День 1):

-   *V1_VIT_HR_ABN* — Наличие отклонения частоты сердечных сокращений (ЧСС).
-   *V1_VIT_RR_ABN* — Наличие отклонения частоты дыхательных движений (ЧДД).
-   *V1_VIT_BP_ABN* — Наличие отклонения артериального давления (АД).
-   *V1_VIT_TEMP_ABN* — Наличие отклонения температуры тела.

Измерено на Визите 2 (День 90):

-   *V2_VIT_HR_ABN* — Наличие отклонения ЧСС после лечения.
-   *V2_VIT_RR_ABN* — Наличие отклонения ЧДД после лечения.
-   *V2_VIT_BP_ABN* — Наличие отклонения АД после лечения.
-   *V2_VIT_TEMP_ABN* — Наличие отклонения температуры тела после лечения.

**4. Гормональный профиль**

Уровни ключевых гормонов, регулирующих сперматогенез, измеренные в сыворотке крови.

Измерено на Визите 1 (День 1):

-   *V1_HOR_FSH* — Уровень фолликулостимулирующего гормона (ФСГ), МЕ/л.
-   *V1_HOR_LH* — Уровень лютеинизирующего гормона (ЛГ), МЕ/л.
-   *V1_HOR_TT* — Уровень общего тестостерона, нг/дл.

Измерено на Визите 2 (День 90):

-   *V2_HOR_FSH* — Уровень ФСГ после лечения.
-   *V2_HOR_LH* — Уровень ЛГ после лечения.
-   *V2_HOR_TT* — Уровень общего тестостерона после лечения.

**5. Биохимические маркеры L-карнитина**

Показатели, отражающие фармакокинетику и метаболизм исследуемого препарата.

Измерено на Визите 1 (День 1):

-   *V1_LCA_B_FREE* — Концентрация свободного L-карнитина в крови (усл. ед.).
-   *V1_LCA_B_TOTAL* — Концентрация общего L-карнитина в крови (усл. ед.).
-   *V1_LCA_U_FREE* — Концентрация свободного L-карнитина в моче (усл. ед.).
-   *V1_LCA_U_TOTAL* — Концентрация общего L-карнитина в моче (усл. ед.).

Измерено на Визите 2 (День 90):

-   *V2_LCA_B_FREE* — Концентрация свободного L-карнитина в крови.
-   *V2_LCA_B_TOTAL* — Концентрация общего L-карнитина в крови.
-   *V2_LCA_U_FREE* — Концентрация свободного L-карнитина в моче.
-   *V2_LCA_U_TOTAL* — Концентрация общего L-карнитина в моче.

**6. Лабораторные параметры эякулята**

**6.1. Суммарная антиоксидантная способность (TAC)**

Показатель, отражающий способность семенной плазмы нейтрализовать окислительный стресс, который является одним из факторов мужского бесплодия.

-   *V1_TAC_TAC* — Измерена на Визите 1 (День 1), усл. ед.
-   *V2_TAC_TAC* — Измерена на Визите 2 (День 90), усл. ед.

**6.2. Параметры спермограммы (ключевые исходы эффективности)**

Нормативные пороги: Концентрация ≥15 млн/мл, Прогрессивная подвижность ≥32%, Нормальная морфология ≥4% согласно руководству ВОЗ (2010).

Измерено на Визите 1 (День 1):

-   *V1_SEM_CONC* — Концентрация сперматозоидов, млн/мл.
-   *V1_SEM_PMOT* — Процент сперматозоидов с прогрессивной подвижностью (%).
-   *V1_SEM_MORPH* — Процент сперматозоидов с нормальной морфологией (%).

Измерено на Визите 2 (День 90):

-   *V2_SEM_CONC* — Концентрация сперматозоидов, млн/мл.
-   *V2_SEM_PMOT* — Процент сперматозоидов с прогрессивной подвижностью (%).
-   *V2_SEM_MORPH* — Процент сперматозоидов с нормальной морфологией (%).

# Эксплораторный анализ

```{r}
data_clean <- data %>% 
  mutate(across(c(USUBJID, ARM, V1_DEM_SEX,
                  V1_VIT_HR_ABN, V1_VIT_RR_ABN, V1_VIT_BP_ABN, V1_VIT_TEMP_ABN,
                  V2_VIT_HR_ABN, V2_VIT_RR_ABN, V2_VIT_BP_ABN, V2_VIT_TEMP_ABN), as.factor)) 

# summary(data_clean)

```

## Описательная статистика

```{r}
# Создаем датафрейм с описательной статистикой
desc_stats <- data.frame(
  Характеристика = character(),
  Значение = character(),
  stringsAsFactors = FALSE
)

# Функция для добавления заголовка раздела (будет занимать 2 столбца)
add_header <- function(section_name) {
  desc_stats <<- rbind(desc_stats, 
                      data.frame(Характеристика = section_name,
                                 Значение = "",
                                 stringsAsFactors = FALSE))
}

# Функция для добавления строк с данными
add_stat <- function(characteristic, value) {
  desc_stats <<- rbind(desc_stats, 
                      data.frame(Характеристика = characteristic,
                                 Значение = value,
                                 stringsAsFactors = FALSE))
}

n_total <- nrow(data_clean)

# 1. ОБЩАЯ ИНФОРМАЦИЯ
add_header("ОБЩАЯ ИНФОРМАЦИЯ")
add_stat("Всего пациентов", sprintf("N = %d", n_total))
add_stat("Группа L-карнитин", 
         sprintf("%d (%.1f%%)", sum(data_clean$ARM == "L-carnitine"),
                 sum(data_clean$ARM == "L-carnitine")/n_total*100))
add_stat("Группа плацебо", 
         sprintf("%d (%.1f%%)", sum(data_clean$ARM == "Placebo"),
                 sum(data_clean$ARM == "Placebo")/n_total*100))

# 2. ДЕМОГРАФИЧЕСКИЕ ХАРАКТЕРИСТИКИ
add_header("ДЕМОГРАФИЧЕСКИЕ ХАРАКТЕРИСТИКИ (ИСХОДНО, V1)")
add_stat("Возраст, лет (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_DEM_AGE), sd(data_clean$V1_DEM_AGE)))
add_stat("Диапазон возраста", 
         sprintf("%d - %d лет", min(data_clean$V1_DEM_AGE), max(data_clean$V1_DEM_AGE)))
add_stat("Рост, см (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_ANT_HEIGHTCM), sd(data_clean$V1_ANT_HEIGHTCM)))
add_stat("Вес, кг (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_ANT_WEIGHTKG), sd(data_clean$V1_ANT_WEIGHTKG)))
add_stat("ИМТ, кг/м² (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_ANT_BMI), sd(data_clean$V1_ANT_BMI)))
add_stat("Диапазон ИМТ", 
         sprintf("%.1f - %.1f", min(data_clean$V1_ANT_BMI), max(data_clean$V1_ANT_BMI)))

# 3. ГОРМОНАЛЬНЫЙ ПРОФИЛЬ
add_header("ГОРМОНАЛЬНЫЙ ПРОФИЛЬ (ИСХОДНО, V1)")
add_stat("ФСГ, МЕ/л (среднее ± СО)", 
         sprintf("%.2f ± %.2f", mean(data_clean$V1_HOR_FSH), sd(data_clean$V1_HOR_FSH)))
add_stat("ЛГ, МЕ/л (среднее ± СО)", 
         sprintf("%.2f ± %.2f", mean(data_clean$V1_HOR_LH), sd(data_clean$V1_HOR_LH)))
add_stat("Тестостерон, нг/дл (среднее ± СО)", 
         sprintf("%.0f ± %.0f", mean(data_clean$V1_HOR_TT), sd(data_clean$V1_HOR_TT)))

# 4. БИОХИМИЯ L-КАРНИТИНА (ИСХОДНЫЕ УРОВНИ)
add_header("БИОХИМИЯ L-КАРНИТИНА (ИСХОДНО, V1)")
add_stat("Свободный L-карнитин в крови, ед. (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_LCA_B_FREE), sd(data_clean$V1_LCA_B_FREE)))
add_stat("Общий L-карнитин в крови, ед. (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_LCA_B_TOTAL), sd(data_clean$V1_LCA_B_TOTAL)))
add_stat("Свободный L-карнитин в моче, ед. (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_LCA_U_FREE), sd(data_clean$V1_LCA_U_FREE)))
add_stat("Общий L-карнитин в моче, ед. (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_LCA_U_TOTAL), sd(data_clean$V1_LCA_U_TOTAL)))

# 5. БИОХИМИЯ L-КАРНИТИНА (ПОСЛЕ ЛЕЧЕНИЯ)
add_header("БИОХИМИЯ L-КАРНИТИНА (ПОСЛЕ ЛЕЧЕНИЯ, V2)")
add_stat("Свободный L-карнитин в крови, ед. (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V2_LCA_B_FREE), sd(data_clean$V2_LCA_B_FREE)))
add_stat("Общий L-карнитин в крови, ед. (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V2_LCA_B_TOTAL), sd(data_clean$V2_LCA_B_TOTAL)))
add_stat("Свободный L-карнитин в моче, ед. (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V2_LCA_U_FREE), sd(data_clean$V2_LCA_U_FREE)))
add_stat("Общий L-карнитин в моче, ед. (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V2_LCA_U_TOTAL), sd(data_clean$V2_LCA_U_TOTAL)))


# 6. СПЕРМОГРАММА - ИСХОДНЫЕ ПОКАЗАТЕЛИ
add_header("СПЕРМОГРАММА - ИСХОДНЫЕ ПОКАЗАТЕЛИ (V1)")
add_stat("Концентрация сперматозоидов, млн/мл (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_SEM_CONC), sd(data_clean$V1_SEM_CONC)))
add_stat("Пациенты с нормальной концентрацией (≥15 млн/мл)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V1_SEM_CONC >= 15),
                 sum(data_clean$V1_SEM_CONC >= 15)/n_total*100))
add_stat("Прогрессивная подвижность, % (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_SEM_PMOT), sd(data_clean$V1_SEM_PMOT)))
add_stat("Пациенты с нормальной подвижностью (≥32%)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V1_SEM_PMOT >= 32),
                 sum(data_clean$V1_SEM_PMOT >= 32)/n_total*100))
add_stat("Нормальная морфология, % (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_SEM_MORPH), sd(data_clean$V1_SEM_MORPH)))
add_stat("Пациенты с нормальной морфологией (≥4%)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V1_SEM_MORPH >= 4),
                 sum(data_clean$V1_SEM_MORPH >= 4)/n_total*100))

# 7. СПЕРМОГРАММА - ПОСЛЕ ЛЕЧЕНИЯ
add_header("СПЕРМОГРАММА - ПОСЛЕ ЛЕЧЕНИЯ (V2, ДЕНЬ 90)")
add_stat("Концентрация сперматозоидов, млн/мл (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V2_SEM_CONC), sd(data_clean$V2_SEM_CONC)))
add_stat("Пациенты с нормальной концентрацией (≥15 млн/мл)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V2_SEM_CONC >= 15),
                 sum(data_clean$V2_SEM_CONC >= 15)/n_total*100))
add_stat("Прогрессивная подвижность, % (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V2_SEM_PMOT), sd(data_clean$V2_SEM_PMOT)))
add_stat("Пациенты с нормальной подвижностью (≥32%)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V2_SEM_PMOT >= 32),
                 sum(data_clean$V2_SEM_PMOT >= 32)/n_total*100))
add_stat("Нормальная морфология, % (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V2_SEM_MORPH), sd(data_clean$V2_SEM_MORPH)))
add_stat("Пациенты с нормальной морфологией (≥4%)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V2_SEM_MORPH >= 4),
                 sum(data_clean$V2_SEM_MORPH >= 4)/n_total*100))

# 8. АНТИОКСИДАНТНАЯ СПОСОБНОСТЬ
add_header("АНТИОКСИДАНТНАЯ СПОСОБНОСТЬ СЕМЕННОЙ ПЛАЗМЫ")
add_stat("Суммарная антиоксидантная способность, ед. (V1)", 
         sprintf("%.3f ± %.3f", mean(data_clean$V1_TAC_TAC), sd(data_clean$V1_TAC_TAC)))
add_stat("Суммарная антиоксидантная способность, ед. (V2)", 
         sprintf("%.3f ± %.3f", mean(data_clean$V2_TAC_TAC), sd(data_clean$V2_TAC_TAC)))

# 9. ВИТАЛЬНЫЕ ПРИЗНАКИ - ОТКЛОНЕНИЯ
add_header("ВИТАЛЬНЫЕ ПРИЗНАКИ - ПАЦИЕНТЫ С ОТКЛОНЕНИЯМИ")
add_stat("Отклонение ЧСС (V1)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V1_VIT_HR_ABN == "1"),
                 sum(data_clean$V1_VIT_HR_ABN == "1")/n_total*100))
add_stat("Отклонение ЧСС (V2)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V2_VIT_HR_ABN == "1"),
                 sum(data_clean$V2_VIT_HR_ABN == "1")/n_total*100))
add_stat("Отклонение ЧДД (V1)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V1_VIT_RR_ABN == "1"),
                 sum(data_clean$V1_VIT_RR_ABN == "1")/n_total*100))
add_stat("Отклонение ЧДД (V2)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V2_VIT_RR_ABN == "1"),
                 sum(data_clean$V2_VIT_RR_ABN == "1")/n_total*100))
add_stat("Отклонение АД (V1)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V1_VIT_BP_ABN == "1"),
                 sum(data_clean$V1_VIT_BP_ABN == "1")/n_total*100))
add_stat("Отклонение АД (V2)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V2_VIT_BP_ABN == "1"),
                 sum(data_clean$V2_VIT_BP_ABN == "1")/n_total*100))
add_stat("Отклонение температуры (V1)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V1_VIT_TEMP_ABN == "1"),
                 sum(data_clean$V1_VIT_TEMP_ABN == "1")/n_total*100))
add_stat("Отклонение температуры (V2)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V2_VIT_TEMP_ABN == "1"),
                 sum(data_clean$V2_VIT_TEMP_ABN == "1")/n_total*100))

# Создаем таблицу с flextable
ft_desc <- flextable(desc_stats) %>%
  # Настройка шрифтов и размеров
  fontsize(size = 9, part = "all") %>%
  font(fontname = "Times New Roman", part = "all") %>%
  # Выравнивание - заголовки столбцов по центру
  align(align = "center", part = "header") %>%
  # Выравнивание тела таблицы
  align(align = "left", part = "body") %>%
  align(j = 2, align = "right", part = "body") %>%
  # Заголовок таблицы
  set_caption("Таблица 1. Описательная статистика выборки (N = 114 пациентов)") %>%
  # Подпись
  add_footer_lines("Примечание: V1 - исходный визит (День 1), V2 - визит после лечения (День 90); 
Нормативные значения ВОЗ (2010): Концентрация ≥15 млн/мл, Подвижность ≥32%, Морфология ≥4%; 
ЧСС - частота сердечных сокращений, ЧДД - частота дыхательных движений, АД - артериальное давление") %>%
  # Автоподбор ширины
  autofit() %>%
  # Добавляем границы между всеми ячейками
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1)) %>%
  # Жирный шрифт для заголовков таблицы
  bold(part = "header") %>%
  # Цвет фона для заголовка таблицы
  bg(bg = "#f2f2f2", part = "header") %>%
  # отступы для лучшей читаемости
  padding(padding = 4, part = "all") %>%
  # Устанавливаем ширину столбцов
  width(width = c(4, 2))

# индексы строк с заголовками разделов
section_indices <- which(desc_stats$Значение == "")

# форматирование к заголовкам разделов
for(idx in section_indices) {
  ft_desc <- ft_desc %>%
    # Объединяем ячейки для заголовка раздела
    merge_at(i = idx, j = 1:2, part = "body") %>%
    # Выравнивание по центру
    align(i = idx, align = "center", part = "body") %>%
    # Жирный шрифт
    bold(i = idx, part = "body") %>%
    # Цвет фона
    bg(i = idx, bg = "#f8f8f8", part = "body") %>%
    # Границы
    border(i = idx, 
           border.top = fp_border(color = "black", width = 1),
           border.bottom = fp_border(color = "black", width = 1),
           part = "body")
}

# Отображаем таблицу
ft_desc
```

```{r}
cat("Пропуски в данных:\n")
print(colSums(is.na(data_clean))[colSums(is.na(data_clean)) > 0])
cat("\nВсего строк с пропусками:", sum(!complete.cases(data_clean)))
```

-   В датасете не обнаружено пропущенных значений.
-   Группы сбалансированы по размеру (57 vs 57).
-   Все переменные имеют ожидаемые диапазоны значений, кроме ИМТ (есть пациенты с ожирением, ИМТ > 30), аномалий в суммарной статистике не обнаружено.

## Анализ ИМТ пациентов

Согласно критериям невключения, в КИ не должны входить пациенты с ожирением и/или метаболическим синдромом, так как эти состояния могут влиять на репродуктивную функцию и результаты лечения.

Оценим ИМТ в нашей выборке.

```{r}
# Создаем таблицу распределения по ИМТ
n_total <- nrow(data_clean)  # Сохраняем общее количество

bmi_table_data <- data_clean %>%
  mutate(
    BMI_Category = case_when(
      V1_ANT_BMI < 18.5 ~ "Недостаточный вес (<18.5)",
      V1_ANT_BMI >= 18.5 & V1_ANT_BMI < 25 ~ "Нормальный вес (18.5-24.9)",
      V1_ANT_BMI >= 25 & V1_ANT_BMI < 30 ~ "Избыточный вес (25-29.9)",
      V1_ANT_BMI >= 30 ~ "Ожирение (≥30)",
      TRUE ~ "Не определено"
    )
  ) %>%
  group_by(BMI_Category) %>%
  summarise(
    n = n(),
    Percent = round(n / n_total * 100, 1),  # Используем n_total вместо n()
    .groups = "drop"
  ) %>%
  arrange(factor(BMI_Category, levels = c(
    "Недостаточный вес (<18.5)",
    "Нормальный вес (18.5-24.9)", 
    "Избыточный вес (25-29.9)",
    "Ожирение (≥30)"
  )))

# Создаем таблицу с flextable
ft_bmi <- flextable(bmi_table_data) %>%
  fontsize(size = 10, part = "all") %>%
  font(fontname = "Times New Roman", part = "all") %>%
  align(align = "center", part = "header") %>%
  align(align = "left", j = 1) %>%
  align(align = "center", j = 2:3) %>%
  set_caption("Таблица 2. Распределение пациентов по категориям индекса массы тела (ИМТ)") %>%
  set_header_labels(
    BMI_Category = "Категория ИМТ (кг/м²)",
    n = "n",
    Percent = "%"
  ) %>%
  add_footer_row(
    top = FALSE,
    values = c("Всего пациентов", sprintf("%d", n_total), "100.0"),
    colwidths = c(1, 1, 1)
  ) %>%
  add_footer_lines("Критерии классификации ИМТ по ВОЗ: недостаточный вес (<18.5), нормальный (18.5-24.9), избыточный (25-29.9), ожирение (≥30)") %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 0.5)) %>%
  border_outer(border = fp_border(color = "black", width = 1)) %>%
  bold(part = "header") %>%
  bold(part = "footer") %>%
  bg(bg = "#f2f2f2", part = "header") %>%
  bg(i = ~ BMI_Category == "Ожирение (≥30)", bg = "#ffe6e6") %>%
  bold(i = ~ BMI_Category == "Ожирение (≥30)") %>%
  padding(padding = 4, part = "all")

# Отображаем таблицу
ft_bmi

```

**Большинство пациентов** (64.9%) имеют избыточный вес или ожирение:

-   Избыточный вес (25-29.9): 41.2%
-   Ожирение (≥30): 23.7%

**Ожирение** присутствует у 27 пациентов (23.7%), что противоречит заявленному критерию исключения исследования.

**Нормальный вес** только у 32.5% пациентов.

**Недостаточный вес** - у 3 пациентов (2.6%).

**Вывод.** В исследовании значительная доля пациентов имеет избыточную массу тела и ожирение. Это важно учитывать при анализе эффективности L-карнитина, так как ожирение может:

-   Влиять на гормональный профиль (снижение тестостерона).
-   Ухудшать параметры спермограммы.
-   Модифицировать ответ на терапию.

##


<br>

# Анализ первичной конечных точек

## Определение первичной конечной точки

Первичная конечная точка: доля пациентов с нормализованной спермограммой к 90-му дню терапии (V2, День 90) по критериям ВОЗ 2010 г. по сравнению с исходным уровнем (V1, День 1).

**Критерии нормализации (все три должны выполняться одновременно):**
- Концентрация сперматозоидов ≥15 млн/мл
- Прогрессивная подвижность ≥32%
- Нормальная морфология ≥4%

```{r}
# Создание бинарных переменных для нормализованной спермограммы
data_primary <- data %>%
  mutate(
    # Нормализация на исходном визите (V1)
    V1_NORMALIZED = ifelse(
      V1_SEM_CONC >= 15 & V1_SEM_PMOT >= 32 & V1_SEM_MORPH >= 4,
      1, 0
    ),
    # Нормализация на визите 2 (V2)
    V2_NORMALIZED = ifelse(
      V2_SEM_CONC >= 15 & V2_SEM_PMOT >= 32 & V2_SEM_MORPH >= 4,
      1, 0
    )
  ) %>%
  # Конвертируем в числовой формат для корректных вычислений
  mutate(
    V1_NORMALIZED = as.numeric(V1_NORMALIZED),
    V2_NORMALIZED = as.numeric(V2_NORMALIZED)
  )

# Описательная статистика по группам
primary_desc <- data_primary %>%
  group_by(ARM) %>%
  summarise(
    n_total = n(),
    # Исходный визит (V1)
    V1_normalized_n = sum(V1_NORMALIZED == 1),
    V1_normalized_pct = round(mean(V1_NORMALIZED == 1) * 100, 1),
    # Визит 2 (V2, 6 месяцев)
    V2_normalized_n = sum(V2_NORMALIZED == 1),
    V2_normalized_pct = round(mean(V2_NORMALIZED == 1) * 100, 1),
    # Изменение
    change_n = V2_normalized_n - V1_normalized_n,
    change_pct = V2_normalized_pct - V1_normalized_pct
  )

print("Описательная статистика первичной конечной точки:")
print(primary_desc)
```

```{r}
# Статистический анализ: сравнение между группами на V2
contingency_table <- table(
  data_primary$ARM, 
  factor(data_primary$V2_NORMALIZED, levels = c(0, 1), labels = c("Не нормализована", "Нормализована"))
)
print("Таблица сопряженности (Группа × Нормализация на V2):")
print(contingency_table)

# Критерий хи-квадрат
chi_square_test <- chisq.test(contingency_table)
cat("\nКритерий хи-квадрат:\n")
print(chi_square_test)

# Расчет относительного риска (RR) и разности долей (RD) с обработкой нулевых значений
if (nrow(contingency_table) == 2 && ncol(contingency_table) == 2) {
  row_names <- rownames(contingency_table)
  lc_row <- which(row_names == "L-carnitine")
  placebo_row <- which(row_names == "Placebo")
  
  a <- contingency_table[lc_row, 2]      # L-carnitine нормализована
  b <- contingency_table[lc_row, 1]      # L-carnitine не нормализована
  c <- contingency_table[placebo_row, 2]  # Placebo нормализована
  d <- contingency_table[placebo_row, 1] # Placebo не нормализована
  
  p1 <- a / (a + b)  # Доля в группе L-carnitine
  p2 <- c / (c + d)  # Доля в группе Placebo
  
  # Разность долей (RD) - рассчитывается всегда
  RD <- p1 - p2
  SE_RD <- sqrt((p1*(1-p1)/(a+b)) + (p2*(1-p2)/(c+d)))
  RD_CI_lower <- RD - 1.96 * SE_RD
  RD_CI_upper <- RD + 1.96 * SE_RD
  
  cat("\nРазность долей (RD):", round(RD, 4))
  cat("\n95% ДИ для RD: [", round(RD_CI_lower, 4), "; ", round(RD_CI_upper, 4), "]\n", sep = "")
  
  # Относительный риск (RR) - только если обе доли > 0
  if (a > 0 && c > 0) {
    RR <- p1 / p2
    log_RR <- log(RR)
    SE_log_RR <- sqrt((1/a) - (1/(a+b)) + (1/c) - (1/(c+d)))
    CI_lower <- exp(log_RR - 1.96 * SE_log_RR)
    CI_upper <- exp(log_RR + 1.96 * SE_log_RR)
    cat("\nОтносительный риск (RR):", round(RR, 3))
    cat("\n95% ДИ для RR: [", round(CI_lower, 3), "; ", round(CI_upper, 3), "]\n", sep = "")
  } else {
    cat("\nОтносительный риск (RR): не может быть рассчитан (нулевые значения в одной из групп)\n")
    RR <- NA
    CI_lower <- NA
    CI_upper <- NA
  }
}
```

```{r}
# Подготовка данных для визуализации
viz_data <- data_primary %>%
  select(ARM, V1_NORMALIZED, V2_NORMALIZED) %>%
  pivot_longer(
    cols = c(V1_NORMALIZED, V2_NORMALIZED),
    names_to = "Visit",
    values_to = "Normalized"
  ) %>%
  mutate(
    Visit = case_when(
      Visit == "V1_NORMALIZED" ~ "Исходный визит (V1)",
      Visit == "V2_NORMALIZED" ~ "90 дней (V2)"
    ),
    Normalized = as.numeric(Normalized)
  ) %>%
  group_by(ARM, Visit) %>%
  summarise(
    n_normalized = sum(Normalized == 1),
    n_total = n(),
    pct = round(mean(Normalized == 1) * 100, 1),
    .groups = "drop"
  )

# Столбчатая диаграмма
p_primary <- ggplot(viz_data, aes(x = Visit, y = pct, fill = ARM)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  geom_text(
    aes(label = paste0(n_normalized, "\n(", pct, "%)")),
    position = position_dodge(width = 0.8),
    vjust = -0.3,
    size = 3.5
  ) +
  scale_fill_manual(
    values = c("L-carnitine" = "#4A90E2", "Placebo" = "#E24A4A"),
    name = "Группа"
  ) +
  labs(
    title = "Доля пациентов с нормализованной спермограммой",
    subtitle = "По критериям ВОЗ 2010 г. (концентрация ≥15 млн/мл, подвижность ≥32%, морфология ≥4%)",
    x = "Визит",
    y = "Доля пациентов, %"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 12, face = "bold"),
    plot.subtitle = element_text(size = 10),
    axis.text = element_text(size = 9),
    axis.title = element_text(size = 10),
    legend.position = "bottom"
  ) +
  ylim(0, max(c(viz_data$pct, 5)) * 1.2)

print(p_primary)
```

```{r}
# Создание итоговой таблицы результатов
primary_results <- data.frame(
  Параметр = character(),
  L_carnitine = character(),
  Placebo = character(),
  Статистика = character(),
  stringsAsFactors = FALSE
)

# Функция для добавления строки
add_row_result <- function(param, lc_val, placebo_val, stat = "") {
  primary_results <<- rbind(
    primary_results,
    data.frame(
      Параметр = param,
      L_carnitine = lc_val,
      Placebo = placebo_val,
      Статистика = stat,
      stringsAsFactors = FALSE
    )
  )
}

# Заголовок
add_row_result("ИТОГИ АНАЛИЗА ПЕРВИЧНОЙ КОНЕЧНОЙ ТОЧКИ", "", "", "")

# Исходный визит (V1)
lc_v1 <- primary_desc %>% filter(ARM == "L-carnitine")
placebo_v1 <- primary_desc %>% filter(ARM == "Placebo")

add_row_result("ИСХОДНЫЙ ВИЗИТ (V1, День 1)", "", "", "")
add_row_result(
  "Пациенты с нормализованной спермограммой",
  sprintf("%d (%.1f%%)", lc_v1$V1_normalized_n, lc_v1$V1_normalized_pct),
  sprintf("%d (%.1f%%)", placebo_v1$V1_normalized_n, placebo_v1$V1_normalized_pct),
  ""
)

# Визит 2 (V2)
add_row_result("ВИЗИТ 2 (V2, День 90)", "", "", "")
add_row_result(
  "Пациенты с нормализованной спермограммой",
  sprintf("%d (%.1f%%)", lc_v1$V2_normalized_n, lc_v1$V2_normalized_pct),
  sprintf("%d (%.1f%%)", placebo_v1$V2_normalized_n, placebo_v1$V2_normalized_pct),
  ""
)

# Изменение
add_row_result("ИЗМЕНЕНИЕ (V2 - V1)", "", "", "")
add_row_result(
  "Изменение количества пациентов",
  sprintf("%+d", lc_v1$change_n),
  sprintf("%+d", placebo_v1$change_n),
  ""
)
add_row_result(
  "Изменение доли, %",
  sprintf("%+.1f%%", lc_v1$change_pct),
  sprintf("%+.1f%%", placebo_v1$change_pct),
  ""
)

# Статистический анализ между группами на V2
add_row_result("СТАТИСТИЧЕСКОЕ СРАВНЕНИЕ МЕЖДУ ГРУППАМИ (V2)", "", "", "")
add_row_result(
  "Критерий хи-квадрат, p-value",
  "",
  "",
  sprintf("%.4f", chi_square_test$p.value)
)
add_row_result(
  "Разность долей (RD), 95% ДИ",
  "",
  "",
  sprintf("%.4f [%.4f; %.4f]", RD, RD_CI_lower, RD_CI_upper)
)
if (exists("RR") && !is.na(RR)) {
  add_row_result(
    "Относительный риск (RR), 95% ДИ",
    "",
    "",
    sprintf("%.3f [%.3f; %.3f]", RR, CI_lower, CI_upper)
  )
} else {
  add_row_result(
    "Относительный риск (RR), 95% ДИ",
    "",
    "",
    "Не может быть рассчитан"
  )
}

# Создание таблицы с flextable
ft_primary <- flextable(primary_results) %>%
  fontsize(size = 9, part = "all") %>%
  font(fontname = "Times New Roman", part = "all") %>%
  align(align = "left", part = "body") %>%
  align(align = "center", part = "header") %>%
  align(j = 2:4, align = "center", part = "body") %>%
  set_caption("Таблица 2. Анализ первичной конечной точки: доля пациентов с нормализованной спермограммой") %>%
  add_footer_lines("Примечание: Нормализация по критериям ВОЗ 2010 г.: концентрация ≥15 млн/мл, прогрессивная подвижность ≥32%, нормальная морфология ≥4%. Все три критерия должны выполняться одновременно. RD - разность долей, RR - относительный риск, ДИ - доверительный интервал. При нулевых значениях в одной из групп RR не может быть рассчитан.") %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1)) %>%
  bold(part = "header") %>%
  bg(bg = "#f2f2f2", part = "header") %>%
  padding(padding = 4, part = "all")

# Форматирование заголовков разделов
section_rows <- which(primary_results$L_carnitine == "" & primary_results$Placebo == "" & primary_results$Статистика == "")
for(idx in section_rows) {
  ft_primary <- ft_primary %>%
    merge_at(i = idx, j = 1:4, part = "body") %>%
    align(i = idx, align = "center", part = "body") %>%
    bold(i = idx, part = "body") %>%
    bg(i = idx, bg = "#f8f8f8", part = "body") %>%
    border(i = idx, 
           border.top = fp_border(color = "black", width = 1),
           border.bottom = fp_border(color = "black", width = 1),
           part = "body")
}

ft_primary
?fisher.test
```
### Интерпретация результатов первичной конечной точки

Анализ первичной конечной точки показал, что доля пациентов с нормализованной спермограммой к 90-му дню терапии (визит V2) была крайне низкой в обеих группах исследования. 

На исходном визите (V1) нормализованная спермограмма по критериям ВОЗ 2010 г. (концентрация ≥15 млн/мл, прогрессивная подвижность ≥32%, нормальная морфология ≥4%) была зарегистрирована у 0 пациентов (0,0%) в группе L-карнитина и у 1 пациента (1,8%) в группе плацебо. К моменту завершения исследования (V2, День 90) показатели остались без изменений: в группе L-карнитина — 0 пациентов (0,0%), в группе плацебо — 1 пациент (1,8%). Изменение доли пациентов с нормализованной спермограммой от исходного уровня составило 0,0% в обеих группах.

Статистическое сравнение между группами на визите V2 не выявило статистически значимых различий: точный критерий Фишера (p = 1,0000) и критерий хи-квадрат (p = 1,0000) показали отсутствие статистически значимой разницы между группами. Разность долей (RD) составила -0,0175 (95% ДИ: -0,0516; 0,0165), что также указывает на отсутствие значимого различия между группами. Относительный риск (RR) не может быть рассчитан в связи с нулевыми значениями в группе L-карнитина.

Полученные результаты свидетельствуют о том, что применение L-карнитина в течение 90 дней не привело к статистически значимому увеличению доли пациентов с нормализованной спермограммой по сравнению с группой плацебо. Низкая частота нормализации в обеих группах может быть связана с тяжестью исходных нарушений сперматогенеза у включенных в исследование пациентов, а также с необходимостью более длительного периода терапии для достижения клинически значимого эффекта.

<br>

# Анализ вторичных конечных точек

## Среднее изменение количественных параметров спермы (концентрации сперматозоидов (млн/мл), прогрессивной подвижности (%) и нормальной морфологии (%)) от исходного уровня к завершению исследования

Для оценки влияния приема препарата (L-карнитин) на динамику параметров спермограммы (концентрации сперматозоидов (млн/мл), прогрессивная подвижность (%) и нормальная морфология (%)) был проведен смешанный дисперсионный анализ (Mixed ANOVA) с факторами "Группа" (Терапия L-карнитином против Плацебо) и "Время" (Визит 1 против Визит 2).

```{r anova_SEM_CONC}
data_SEM_CONC <- data %>%
  pivot_longer(
    cols = c(V1_SEM_CONC, V2_SEM_CONC),
    names_to = "time",
    values_to = "SEM_CONC"
  ) %>%
  mutate(time = str_replace(time, "_SEM_CONC", "")) %>%  
  mutate(time = factor(time, levels = c("V1", "V2")))

SEM_CONC_changes_comparison_anova <- anova_test(
  data = data_SEM_CONC,
  dv = SEM_CONC,
  wid = USUBJID,
  between = ARM, 
  within = time
) %>%
  as_tibble() %>%
  select(Effect, `F`, "p")  %>%
  mutate(Effect = recode(
    Effect,
    ARM = "Терапия",
    time = "Время",
    "ARM:time" = "Терапия:Время")
  )

ft_SEM_CONC_changes_comparison_anova <- SEM_CONC_changes_comparison_anova %>%
  mutate(
    `F` = round(`F`, 2),
    `p` = round(`p`, 4)
  ) %>%
  flextable() %>%
  set_caption(caption = "ANOVA: факторы \"Группа терапии\" и \"Время\",\n переменная \"Концентрация сперматозоидов (млн-мл)\"") %>%
  autofit() %>% 
  set_header_labels(
    values = list(
      Effect = "Фактор",
      `F` = "F-статистика",
      `p`= "p-значение"
    )
  ) %>%
  bold(part = "header")  %>%
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body")   

ft_SEM_CONC_changes_comparison_anova
```

Статистически значимого влияния группы, времени и их взаимодействия на "Концентрацию сперматозоидов (млн-мл)" не выявлено ($p = 0.087$). Размеры эффектов были пренебрежимо малы. 

```{r anova_SEM_PMOT}
data_SEM_PMOT <- data %>%
  pivot_longer(
    cols = c(V1_SEM_PMOT, V2_SEM_PMOT),
    names_to = "time",
    values_to = "SEM_PMOT"
  ) %>%
  mutate(time = str_replace(time, "_SEM_PMOT", "")) %>%  
  mutate(time = factor(time, levels = c("V1", "V2")))

SEM_PMOT_changes_comparison_anova <- anova_test(
  data = data_SEM_PMOT,
  dv = SEM_PMOT,
  wid = USUBJID,
  between = ARM, 
  within = time
) %>%
  as_tibble() %>%
  select(Effect, `F`, "p")  %>%
  mutate(Effect = recode(
    Effect,
    ARM = "Терапия",
    time = "Время",
    "ARM:time" = "Терапия:Время")
  )

ft_SEM_PMOT_changes_comparison_anova <- SEM_PMOT_changes_comparison_anova %>%
  mutate(
    `F` = round(`F`, 2),
    `p` = round(`p`, 4)
  ) %>%
  flextable() %>%
  set_caption(caption = "ANOVA: факторы \"Группа терапии\" и \"Время\",\n переменная \"Прогрессивная подвижность (%)\"") %>%
  autofit() %>% 
  set_header_labels(
    values = list(
      Effect = "Фактор",
      `F` = "F-статистика",
      `p`= "p-значение"
    )
  ) %>%
  bold(part = "header")  %>%
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body")   

ft_SEM_PMOT_changes_comparison_anova
```
Статистически значимого влияния группы, времени и их взаимодействия на "Прогрессивная подвижность (%)" не выявлено ($p = 0.329$). Размеры эффектов были пренебрежимо малы.

```{r anova_SEM_MORPH}
data_SEM_MORPH <- data %>%
  pivot_longer(
    cols = c(V1_SEM_MORPH, V2_SEM_MORPH),
    names_to = "time",
    values_to = "SEM_MORPH"
  ) %>%
  mutate(time = str_replace(time, "_SEM_MORPH", "")) %>%  
  mutate(time = factor(time, levels = c("V1", "V2")))

SEM_MORPH_changes_comparison_anova <- anova_test(
  data = data_SEM_MORPH,
  dv = SEM_MORPH,
  wid = USUBJID,
  between = ARM, 
  within = time
  ) %>%
  as_tibble() %>%
  select(Effect, `F`, "p")  %>%
  mutate(Effect = recode(
    Effect,
    ARM = "Терапия",
    time = "Время",
    "ARM:time" = "Терапия:Время")
  )

ft_SEM_MORPH_changes_comparison_anova <- SEM_MORPH_changes_comparison_anova %>%
  mutate(
    `F` = round(`F`, 2),
    `p` = round(`p`, 4)
  ) %>%
  flextable() %>%
  set_caption(caption = "ANOVA: факторы \"Группа терапии\" и \"Время\",\n переменная \"Нормальная морфология (%)\"") %>%
  autofit() %>% 
  set_header_labels(
    values = list(
      Effect = "Фактор",
      `F` = "F-статистика",
      `p`= "p-значение"
    )
  ) %>%
  bold(part = "header")  %>%
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body")   

ft_SEM_MORPH_changes_comparison_anova
```
Первичный анализ (Таблица ANOVA) выявил статистически значимое взаимодействие факторов Группа × Время ($F(1, 112) = 9.16 , p = 0.003$). Это указывает на то, что изменение показателя морфологии во времени достоверно различалось между группой, принимавшей L-карнитин, и группой плацебо.  Также статистически значимым оказался межгрупповой эффект терапии ($p = 0.03$).  Поскольку анализ показал отсутствие общего основного эффекта времени ($p = 0.84$), то был проведен дополнительно t-тест для оценки различий между группами на первом визите (день 0).

```{r day_1_SEM_MORPH}
SEM_MORPH_t_test <- data_SEM_MORPH %>%
  filter(time == "V1") %>%
  t_test(SEM_MORPH ~ ARM) %>%
  select(`.y.`, `p`) %>%
  mutate(`.y.` = recode(
    `.y.`,
    SEM_MORPH = "Нормальная морфология (%)")
  )

ft_SEM_MORPH_t_test<- SEM_MORPH_t_test %>%
  mutate(
    `p` = round(`p`, 4)
  ) %>%
  flextable() %>%
  set_caption(caption = "t-тест: факторы \"Нормальная морфология (%)\" ~ \"Группа терапии\", визит 1 (день 0)") %>%
  autofit() %>% 
  set_header_labels(
    values = list(
      `.y.` = "Признак",
      `p`= "p-значение"
    )
  ) %>%
  bold(part = "header")  %>%
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body")   

ft_SEM_MORPH_t_test
```
Однако проверка исходной сопоставимости групп (t-тест для Визита 1) показала наличие статистически значимых различий до начала терапии ($p = 0.02$). Поскольку исходная неоднородность выборки может искажать результаты ANOVA, за счет эффекта регрессии к среднему, для верификации эффективности препарата был применен ковариационный анализ (ANCOVA). Данный метод позволяет оценить влияние терапии на конечный результат (Визит 2), математически нивелируя разницу в исходных показателях (Визит 1).

```{r ancova_SEM_MORPH}
SEM_MORPH_changes_comparison_ancova <- lm(V2_SEM_MORPH ~ ARM + V1_SEM_MORPH, data = data) %>%
  tidy(conf.int = TRUE,
       conf.level = 0.95
       ) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  mutate(
    estimate = round(estimate, 2),
    conf.low  = round(conf.low, 2),
    conf.high = round(conf.high, 2),
    p.value = round(p.value, 4),
    term = recode(
      term,
      `(Intercept)` = "Константа",
      ARMPlacebo = "Терапия",
      V1_SEM_MORPH = "Нормальная морфология (%), визит 1"
    )
  ) %>%
  filter(term == "Терапия")

r2_value <- glance(SEM_MORPH_changes_comparison_ancova$r.squared) %>%
  round(3)

ft_SEM_MORPH_changes_comparison_ancova <- flextable(SEM_MORPH_changes_comparison_ancova) %>%
  set_caption(
    paste0(
      "ANCOVA: влияние терапии на V2 SEM_MORPH (R² = ", r2_value, ")"
    )
  ) %>%
  set_header_labels(
    term = "Предиктор",
    estimate = "Оценка (β)",
    p.value = "p-значение",
    conf.low = "Верхняя граница 95% ДИ",
    conf.high = "Нижняя граница 95% ДИ"
  ) %>%
  bold(part = "header") %>%
  align(align = "center", part = "all") %>%
  autofit()

ft_SEM_MORPH_changes_comparison_ancova
```
Модель продемонстрировала высокую точность аппроксимации ($R^2 = 0.99, p < 0.001$), что свидетельствует о сильной зависимости итоговых значений морфологии от исходного уровня пациента. Важно, что даже после жесткой коррекции на исходный уровень фактор терапии сохранил высокую статистическую значимость ($p = 0.003$). Расчетные коэффициенты модели ($Терапия = -0.11$) показывают, что при условии равного старта группа Плацебо демонстрирует результат статистически значимо ниже, чем группа L-карнитина. 95% доверительный интервал для коэффициента терапии составил −0.18;−0.04 и не включает ноль, что подтверждает статистическую значимость выявленного эффекта..

Наблюдаемое улучшение показателей в группе терапии не является артефактом исходных различий. Прием L-карнитина оказывает самостоятельный, статистически подтвержденный положительный эффект на процент нормальной морфологии сперматозоидов по сравнению с плацебо. Однако, интерпретируя полученные результаты, необходимо учитывать величину наблюдаемого эффекта. Диапазон значений нормальной морфологии в анализируемой выборке варьировал от 0.1% до 9.5%, а расчетное преимущество группы терапии составило всего 0.11 процентных пункта. Несмотря на высокую статистическую достоверность ($p = 0.003$), клиническая значимость такого малого прироста требует дополнительной оценки профильным специалистом, так как столь незначительные изменения могут не оказывать существенного влияния на фертильный потенциал в соответствии с критериями ВОЗ (нижняя граница нормы — 4%).

<br>

## Гормональный профиль и биохимические маркеры (тестостерон, ФСГ, ЛГ).

```{r anova_HOR_FSH}
data_HOR_FSH <- data %>%
  pivot_longer(
    cols = c(V1_HOR_FSH, V2_HOR_FSH),
    names_to = "time",
    values_to = "HOR_FSH"
  ) %>%
  mutate(time = str_replace(time, "_HOR_FSH", "")) %>%  
  mutate(time = factor(time, levels = c("V1", "V2")))

HOR_FSH_anova <- anova_test(
  data = data_HOR_FSH,
  dv = HOR_FSH,
  wid = USUBJID,
  between = ARM, 
  within = time
) %>%
  as_tibble() %>%
  select(Effect, `F`, "p")  %>%
  mutate(Effect = recode(
    Effect,
    ARM = "Терапия",
    time = "Время",
    "ARM:time" = "Терапия:Время")
  )

ft_HOR_FSH_anova <- HOR_FSH_anova %>%
  mutate(
    `F` = round(`F`, 2),
    `p` = round(`p`, 4)
  ) %>%
  flextable() %>%
  set_caption(caption = "ANOVA: факторы \"Группа терапии\" и \"Время\",\n переменная \"Фолликуло-стимулирующий гормон (МЕ/Л)\"") %>%
  autofit() %>% 
  set_header_labels(
    values = list(
      Effect = "Фактор",
      `F` = "F-статистика",
      `p`= "p-значение"
    )
  ) %>%
  bold(part = "header")  %>%
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body")   

ft_HOR_FSH_anova
```

Статистически значимого влияния группы, времени и их взаимодействия на "Фолликуло-стимулирующий гормон (МЕ/Л)" не выявлено ($p = 0.332$). Размеры эффектов были пренебрежимо малы.

```{r anova_HOR_LH}
data_HOR_LH <- data %>%
  pivot_longer(
    cols = c(V1_HOR_LH, V2_HOR_LH),
    names_to = "time",
    values_to = "HOR_LH"
  ) %>%
  mutate(time = str_replace(time, "_HOR_LH", "")) %>%  
  mutate(time = factor(time, levels = c("V1", "V2")))

HOR_LH_anova <- anova_test(
  data = data_HOR_LH,
  dv = HOR_LH,
  wid = USUBJID,
  between = ARM, 
  within = time
) %>%
  as_tibble() %>%
  select(Effect, `F`, "p")  %>%
  mutate(Effect = recode(
    Effect,
    ARM = "Терапия",
    time = "Время",
    "ARM:time" = "Терапия:Время")
  )

ft_HOR_LH_anova <- HOR_LH_anova %>%
  mutate(
    `F` = round(`F`, 2),
    `p` = round(`p`, 4)
  ) %>%
  flextable() %>%
  set_caption(caption = "ANOVA: факторы \"Группа терапии\" и \"Время\",\n переменная \"Лютеинизирующий гормон (МЕ/Л)\"") %>%
  autofit() %>% 
  set_header_labels(
    values = list(
      Effect = "Фактор",
      `F` = "F-статистика",
      `p`= "p-значение"
    )
  ) %>%
  bold(part = "header")  %>%
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body")   

ft_HOR_LH_anova
```

Статистически значимого влияния группы, времени и их взаимодействия на "Лютеинизирующий гормон (МЕ/Л)" не выявлено ($p = 0.48$). Размеры эффектов были пренебрежимо малы.

```{r anova_HOR_TT}
data_HOR_TT <- data %>%
  pivot_longer(
    cols = c(V1_HOR_TT, V2_HOR_TT),
    names_to = "time",
    values_to = "HOR_TT"
  ) %>%
  mutate(time = str_replace(time, "_HOR_TT", "")) %>%  
  mutate(time = factor(time, levels = c("V1", "V2")))

HOR_TT_anova <- anova_test(
  data = data_HOR_TT,
  dv = HOR_TT,
  wid = USUBJID,
  between = ARM, 
  within = time
) %>%
  as_tibble() %>%
  select(Effect, `F`, "p")  %>%
  mutate(Effect = recode(
    Effect,
    ARM = "Терапия",
    time = "Время",
    "ARM:time" = "Терапия:Время")
  )

ft_HOR_TT_anova <- HOR_TT_anova %>%
  mutate(
    `F` = round(`F`, 2),
    `p` = round(`p`, 4)
  ) %>%
  flextable() %>%
  set_caption(caption = "ANOVA: факторы \"Группа терапии\" и \"Время\",\n переменная \"Обший тестостерон (МЕ/Л)\"") %>%
  autofit() %>% 
  set_header_labels(
    values = list(
      Effect = "Фактор",
      `F` = "F-статистика",
      `p`= "p-значение"
    )
  ) %>%
  bold(part = "header")  %>%
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body")   

ft_HOR_TT_anova
```
Статистически значимого влияния группы, времени и их взаимодействия на "Обший тестостерон (МЕ/Л)" не выявлено ($p = 0.15$). Размеры эффектов были пренебрежимо малы.

<br>

## Суммарная антиоксидантная способность семенной плазмы (ммоль/л).

```{r anova_TAC_TAC}
data_TAC_TAC <- data %>%
  pivot_longer(
    cols = c(V1_TAC_TAC, V2_TAC_TAC),
    names_to = "time",
    values_to = "TAC_TAC"
  ) %>%
  mutate(time = str_replace(time, "_TAC_TAC", "")) %>%  
  mutate(time = factor(time, levels = c("V1", "V2")))

TAC_TAC_anova <- anova_test(
  data = data_TAC_TAC,
  dv = TAC_TAC,
  wid = USUBJID,
  between = ARM, 
  within = time
) %>%
  as_tibble() %>%
  select(Effect, `F`, "p")  %>%
  mutate(Effect = recode(
    Effect,
    ARM = "Терапия",
    time = "Время",
    "ARM:time" = "Терапия:Время")
  )

ft_TAC_TAC_anova <- TAC_TAC_anova %>%
  mutate(
    `F` = round(`F`, 2),
    `p` = round(`p`, 4)
  ) %>%
  flextable() %>%
  set_caption(caption = "ANOVA: факторы \"Группа терапии\" и \"Время\",\n переменная \"Суммарная антиоксидантная способность семенной плазмы (a.u.)\"") %>%
  autofit() %>% 
  set_header_labels(
    values = list(
      Effect = "Фактор",
      `F` = "F-статистика",
      `p`= "p-значение"
    )
  ) %>%
  bold(part = "header")  %>%
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body")   

ft_TAC_TAC_anova
```
Статистически значимого влияния группы, времени и их взаимодействия на "Обший тестостерон (МЕ/Л)" не выявлено ($p = 0.623$). Размеры эффектов были пренебрежимо малы.

<br>

# Анализ параметров безопасности

<br>
