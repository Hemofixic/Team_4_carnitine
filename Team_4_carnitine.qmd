---
title: "Многоцентровое проспективное рандомизированное двойное слепое плацебо-контролируемое исследование эффективности и безопасности L-карнитина в терапии мужского бесплодия при нарушениях параметров спермы (олиго-, астено- и/или тератозооспермия)"
author: "Ахметова Мария, Валиев Иван, Шовгенов Ислам, Козлова Ирина"
date: 18.01.2026
lang: ru
format:
  docx:
    toc: true
    toc-depth: 3
    number-sections: true
    highlight-style: tango
number-sections: true
execute:
    echo: true
    warning: false
    message: false
---

```{r}
library(tidyverse)
library(rstatix)
library(flextable)
library(broom)
library(officer)
library(ggplot2)
```

```{r}
data <- read.csv("data/team4_ecrf_wide.csv")
```

# Информация о клиническом исследовании

**Исследуемый препарат:** L-карнитин.

**Препарат сравнения:** Плацебо.

В исследование включено (рандомизировано) **114 мужчин** от 20 до 50 лет (по 57 пациентов в каждую группу).

**Целью данного исследования** является оценка терапевтической эффективности и безопасности  препаратов L-карнитина при лечении мужского бесплодия при нарушениях параметров спермы (олиго-, астено- и/или тератозооспермия).

**Дизайн исследования:** Проспективное, многоцентровое, двойное слепое, рандомизированное, клиническое исследование в параллельных группах.


# Информация о переменных

Все названия переменных (столбцов) следуют единому шаблону:

-   V1\_ — измерения, проведённые на первом визите (День 1), то есть исходные, базовые показатели.
-   V2\_ — измерения, проведённые на втором визите (День 90), то есть показатели после курса терапии.
-   После префикса визита следует код домена (категории данных), например DEM (демография), SEM (спермограмма).
-   Заканчивается название конкретным параметром, например AGE (возраст), CONC (концентрация).
-   Данные хранятся в формате "один пациент — одна строка" (wide format).

**1. Идентификационные и группирующие переменные**

-   *USUBJID* — Уникальный буквенно-цифровой идентификатор пациента в исследовании.
-   *ARM* — Группа терапи, в которую был рандомизирован пациент. Принимает значения: "Placebo" (группа плацебо) или "L-carnitine" (группа активного лечения).

**2. Демографические и общие данные (измерены на Визите 1)**

Эти переменные описывают базовые характеристики пациентов и были собраны однократно при включении в исследование.

-   *V1_DEM_SEX* — Пол пациента. Все участники исследования — мужчины.
-   *V1_DEM_AGE* — Возраст пациента на момент включения в исследование, полных лет.
-   *V1_ANT_HEIGHTCM* — Рост пациента, измеренный в сантиметрах (см).
-   *V1_ANT_WEIGHTKG* — Масса тела пациента, измеренная в килограммах (кг).
-   *V1_ANT_BMI* — Индекс массы тела (ИМТ), рассчитанный как масса тела (кг) / рост² (м²).

**3. Витальные признаки и безопасность**

Показатели безопасности, оценивавшиеся на обоих визитах. Переменные имеют бинарный (0/1) формат, где 0 означает "Норма", а 1 означает "Отклонение от нормы".

Измерено на Визите 1 (День 1):

-   *V1_VIT_HR_ABN* — Наличие отклонения частоты сердечных сокращений (ЧСС).
-   *V1_VIT_RR_ABN* — Наличие отклонения частоты дыхательных движений (ЧДД).
-   *V1_VIT_BP_ABN* — Наличие отклонения артериального давления (АД).
-   *V1_VIT_TEMP_ABN* — Наличие отклонения температуры тела.

Измерено на Визите 2 (День 90):

-   *V2_VIT_HR_ABN* — Наличие отклонения ЧСС после лечения.
-   *V2_VIT_RR_ABN* — Наличие отклонения ЧДД после лечения.
-   *V2_VIT_BP_ABN* — Наличие отклонения АД после лечения.
-   *V2_VIT_TEMP_ABN* — Наличие отклонения температуры тела после лечения.

**4. Гормональный профиль**

Уровни ключевых гормонов, регулирующих сперматогенез, измеренные в сыворотке крови.

Измерено на Визите 1 (День 1):

-   *V1_HOR_FSH* — Уровень фолликулостимулирующего гормона (ФСГ), МЕ/л.
-   *V1_HOR_LH* — Уровень лютеинизирующего гормона (ЛГ), МЕ/л.
-   *V1_HOR_TT* — Уровень общего тестостерона, нг/дл.

Измерено на Визите 2 (День 90):

-   *V2_HOR_FSH* — Уровень ФСГ после лечения.
-   *V2_HOR_LH* — Уровень ЛГ после лечения.
-   *V2_HOR_TT* — Уровень общего тестостерона после лечения.

**5. Биохимические маркеры L-карнитина**

Показатели, отражающие фармакокинетику и метаболизм исследуемого препарата.

Измерено на Визите 1 (День 1):

-   *V1_LCA_B_FREE* — Концентрация свободного L-карнитина в крови (усл. ед.).
-   *V1_LCA_B_TOTAL* — Концентрация общего L-карнитина в крови (усл. ед.).
-   *V1_LCA_U_FREE* — Концентрация свободного L-карнитина в моче (усл. ед.).
-   *V1_LCA_U_TOTAL* — Концентрация общего L-карнитина в моче (усл. ед.).

Измерено на Визите 2 (День 90):

-   *V2_LCA_B_FREE* — Концентрация свободного L-карнитина в крови.
-   *V2_LCA_B_TOTAL* — Концентрация общего L-карнитина в крови.
-   *V2_LCA_U_FREE* — Концентрация свободного L-карнитина в моче.
-   *V2_LCA_U_TOTAL* — Концентрация общего L-карнитина в моче.

**6. Лабораторные параметры эякулята**

**6.1. Суммарная антиоксидантная способность (TAC)**

Показатель, отражающий способность семенной плазмы нейтрализовать окислительный стресс, который является одним из факторов мужского бесплодия.

-   *V1_TAC_TAC* — Измерена на Визите 1 (День 1), усл. ед.
-   *V2_TAC_TAC* — Измерена на Визите 2 (День 90), усл. ед.

**6.2. Параметры спермограммы (ключевые исходы эффективности)**

Нормативные пороги: Концентрация ≥15 млн/мл, Прогрессивная подвижность ≥32%, Нормальная морфология ≥4% согласно руководству ВОЗ (2010).

Измерено на Визите 1 (День 1):

-   *V1_SEM_CONC* — Концентрация сперматозоидов, млн/мл.
-   *V1_SEM_PMOT* — Процент сперматозоидов с прогрессивной подвижностью (%).
-   *V1_SEM_MORPH* — Процент сперматозоидов с нормальной морфологией (%).

Измерено на Визите 2 (День 90):

-   *V2_SEM_CONC* — Концентрация сперматозоидов, млн/мл.
-   *V2_SEM_PMOT* — Процент сперматозоидов с прогрессивной подвижностью (%).
-   *V2_SEM_MORPH* — Процент сперматозоидов с нормальной морфологией (%).

# Эксплораторный анализ

```{r}
data_clean <- data %>% 
  mutate(across(c(USUBJID, ARM, V1_DEM_SEX,
                  V1_VIT_HR_ABN, V1_VIT_RR_ABN, V1_VIT_BP_ABN, V1_VIT_TEMP_ABN,
                  V2_VIT_HR_ABN, V2_VIT_RR_ABN, V2_VIT_BP_ABN, V2_VIT_TEMP_ABN), as.factor)) 

# summary(data_clean)

```

## Описательная статистика

```{r}
# Создаем датафрейм с описательной статистикой
desc_stats <- data.frame(
  Характеристика = character(),
  Значение = character(),
  stringsAsFactors = FALSE
)

# Функция для добавления заголовка раздела (будет занимать 2 столбца)
add_header <- function(section_name) {
  desc_stats <<- rbind(desc_stats, 
                      data.frame(Характеристика = section_name,
                                 Значение = "",
                                 stringsAsFactors = FALSE))
}

# Функция для добавления строк с данными
add_stat <- function(characteristic, value) {
  desc_stats <<- rbind(desc_stats, 
                      data.frame(Характеристика = characteristic,
                                 Значение = value,
                                 stringsAsFactors = FALSE))
}

n_total <- nrow(data_clean)

# 1. ОБЩАЯ ИНФОРМАЦИЯ
add_header("ОБЩАЯ ИНФОРМАЦИЯ")
add_stat("Всего пациентов", sprintf("N = %d", n_total))
add_stat("Группа L-карнитин", 
         sprintf("%d (%.1f%%)", sum(data_clean$ARM == "L-carnitine"),
                 sum(data_clean$ARM == "L-carnitine")/n_total*100))
add_stat("Группа плацебо", 
         sprintf("%d (%.1f%%)", sum(data_clean$ARM == "Placebo"),
                 sum(data_clean$ARM == "Placebo")/n_total*100))

# 2. ДЕМОГРАФИЧЕСКИЕ ХАРАКТЕРИСТИКИ
add_header("ДЕМОГРАФИЧЕСКИЕ ХАРАКТЕРИСТИКИ (ИСХОДНО, V1)")
add_stat("Возраст, лет (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_DEM_AGE), sd(data_clean$V1_DEM_AGE)))
add_stat("Диапазон возраста", 
         sprintf("%d - %d лет", min(data_clean$V1_DEM_AGE), max(data_clean$V1_DEM_AGE)))
add_stat("Рост, см (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_ANT_HEIGHTCM), sd(data_clean$V1_ANT_HEIGHTCM)))
add_stat("Вес, кг (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_ANT_WEIGHTKG), sd(data_clean$V1_ANT_WEIGHTKG)))
add_stat("ИМТ, кг/м² (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_ANT_BMI), sd(data_clean$V1_ANT_BMI)))
add_stat("Диапазон ИМТ", 
         sprintf("%.1f - %.1f", min(data_clean$V1_ANT_BMI), max(data_clean$V1_ANT_BMI)))


# 4. БИОХИМИЯ L-КАРНИТИНА (ИСХОДНЫЕ УРОВНИ)
add_header("БИОХИМИЯ L-КАРНИТИНА (ИСХОДНО, V1)")
add_stat("Свободный L-карнитин в крови, ед. (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_LCA_B_FREE), sd(data_clean$V1_LCA_B_FREE)))
add_stat("Общий L-карнитин в крови, ед. (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_LCA_B_TOTAL), sd(data_clean$V1_LCA_B_TOTAL)))
add_stat("Свободный L-карнитин в моче, ед. (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_LCA_U_FREE), sd(data_clean$V1_LCA_U_FREE)))
add_stat("Общий L-карнитин в моче, ед. (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_LCA_U_TOTAL), sd(data_clean$V1_LCA_U_TOTAL)))

# 5. БИОХИМИЯ L-КАРНИТИНА (ПОСЛЕ ЛЕЧЕНИЯ)
add_header("БИОХИМИЯ L-КАРНИТИНА (ПОСЛЕ ЛЕЧЕНИЯ, V2)")
add_stat("Свободный L-карнитин в крови, ед. (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V2_LCA_B_FREE), sd(data_clean$V2_LCA_B_FREE)))
add_stat("Общий L-карнитин в крови, ед. (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V2_LCA_B_TOTAL), sd(data_clean$V2_LCA_B_TOTAL)))
add_stat("Свободный L-карнитин в моче, ед. (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V2_LCA_U_FREE), sd(data_clean$V2_LCA_U_FREE)))
add_stat("Общий L-карнитин в моче, ед. (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V2_LCA_U_TOTAL), sd(data_clean$V2_LCA_U_TOTAL)))


# 6. СПЕРМОГРАММА - ИСХОДНЫЕ ПОКАЗАТЕЛИ
add_header("СПЕРМОГРАММА - ИСХОДНЫЕ ПОКАЗАТЕЛИ (V1)")
add_stat("Концентрация сперматозоидов, млн/мл (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_SEM_CONC), sd(data_clean$V1_SEM_CONC)))
add_stat("Пациенты с нормальной концентрацией (≥15 млн/мл)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V1_SEM_CONC >= 15),
                 sum(data_clean$V1_SEM_CONC >= 15)/n_total*100))
add_stat("Прогрессивная подвижность, % (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_SEM_PMOT), sd(data_clean$V1_SEM_PMOT)))
add_stat("Пациенты с нормальной подвижностью (≥32%)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V1_SEM_PMOT >= 32),
                 sum(data_clean$V1_SEM_PMOT >= 32)/n_total*100))
add_stat("Нормальная морфология, % (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V1_SEM_MORPH), sd(data_clean$V1_SEM_MORPH)))
add_stat("Пациенты с нормальной морфологией (≥4%)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V1_SEM_MORPH >= 4),
                 sum(data_clean$V1_SEM_MORPH >= 4)/n_total*100))

# 7. СПЕРМОГРАММА - ПОСЛЕ ЛЕЧЕНИЯ
add_header("СПЕРМОГРАММА - ПОСЛЕ ЛЕЧЕНИЯ (V2, ДЕНЬ 90)")
add_stat("Концентрация сперматозоидов, млн/мл (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V2_SEM_CONC), sd(data_clean$V2_SEM_CONC)))
add_stat("Пациенты с нормальной концентрацией (≥15 млн/мл)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V2_SEM_CONC >= 15),
                 sum(data_clean$V2_SEM_CONC >= 15)/n_total*100))
add_stat("Прогрессивная подвижность, % (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V2_SEM_PMOT), sd(data_clean$V2_SEM_PMOT)))
add_stat("Пациенты с нормальной подвижностью (≥32%)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V2_SEM_PMOT >= 32),
                 sum(data_clean$V2_SEM_PMOT >= 32)/n_total*100))
add_stat("Нормальная морфология, % (среднее ± СО)", 
         sprintf("%.1f ± %.1f", mean(data_clean$V2_SEM_MORPH), sd(data_clean$V2_SEM_MORPH)))
add_stat("Пациенты с нормальной морфологией (≥4%)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V2_SEM_MORPH >= 4),
                 sum(data_clean$V2_SEM_MORPH >= 4)/n_total*100))

# 8. АНТИОКСИДАНТНАЯ СПОСОБНОСТЬ
add_header("АНТИОКСИДАНТНАЯ СПОСОБНОСТЬ СЕМЕННОЙ ПЛАЗМЫ")
add_stat("Суммарная антиоксидантная способность, ед. (V1)", 
         sprintf("%.3f ± %.3f", mean(data_clean$V1_TAC_TAC), sd(data_clean$V1_TAC_TAC)))
add_stat("Суммарная антиоксидантная способность, ед. (V2)", 
         sprintf("%.3f ± %.3f", mean(data_clean$V2_TAC_TAC), sd(data_clean$V2_TAC_TAC)))

# 9. ВИТАЛЬНЫЕ ПРИЗНАКИ - ОТКЛОНЕНИЯ
add_header("ВИТАЛЬНЫЕ ПРИЗНАКИ - ПАЦИЕНТЫ С ОТКЛОНЕНИЯМИ")
add_stat("Отклонение ЧСС (V1)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V1_VIT_HR_ABN == "1"),
                 sum(data_clean$V1_VIT_HR_ABN == "1")/n_total*100))
add_stat("Отклонение ЧСС (V2)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V2_VIT_HR_ABN == "1"),
                 sum(data_clean$V2_VIT_HR_ABN == "1")/n_total*100))
add_stat("Отклонение ЧДД (V1)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V1_VIT_RR_ABN == "1"),
                 sum(data_clean$V1_VIT_RR_ABN == "1")/n_total*100))
add_stat("Отклонение ЧДД (V2)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V2_VIT_RR_ABN == "1"),
                 sum(data_clean$V2_VIT_RR_ABN == "1")/n_total*100))
add_stat("Отклонение АД (V1)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V1_VIT_BP_ABN == "1"),
                 sum(data_clean$V1_VIT_BP_ABN == "1")/n_total*100))
add_stat("Отклонение АД (V2)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V2_VIT_BP_ABN == "1"),
                 sum(data_clean$V2_VIT_BP_ABN == "1")/n_total*100))
add_stat("Отклонение температуры (V1)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V1_VIT_TEMP_ABN == "1"),
                 sum(data_clean$V1_VIT_TEMP_ABN == "1")/n_total*100))
add_stat("Отклонение температуры (V2)", 
         sprintf("%d (%.1f%%)", sum(data_clean$V2_VIT_TEMP_ABN == "1"),
                 sum(data_clean$V2_VIT_TEMP_ABN == "1")/n_total*100))

# Создаем таблицу с flextable
ft_desc <- flextable(desc_stats) %>%
  # Настройка шрифтов и размеров
  fontsize(size = 9, part = "all") %>%
  font(fontname = "Times New Roman", part = "all") %>%
  # Выравнивание - заголовки столбцов по центру
  align(align = "center", part = "header") %>%
  # Выравнивание тела таблицы
  align(align = "left", part = "body") %>%
  align(j = 2, align = "right", part = "body") %>%
  # Заголовок таблицы
  set_caption("Таблица 1. Описательная статистика выборки (N = 114 пациентов)") %>%
  # Подпись
  add_footer_lines("Примечание: V1 - исходный визит (День 1), V2 - визит после лечения (День 90); 
Нормативные значения ВОЗ (2010): Концентрация ≥15 млн/мл, Подвижность ≥32%, Морфология ≥4%; 
ЧСС - частота сердечных сокращений, ЧДД - частота дыхательных движений, АД - артериальное давление") %>%
  # Автоподбор ширины
  autofit() %>%
  # Добавляем границы между всеми ячейками
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1)) %>%
  # Жирный шрифт для заголовков таблицы
  bold(part = "header") %>%
  # Цвет фона для заголовка таблицы
  bg(bg = "#f2f2f2", part = "header") %>%
  # отступы для лучшей читаемости
  padding(padding = 4, part = "all") %>%
  # Устанавливаем ширину столбцов
  width(width = c(4, 2))

# индексы строк с заголовками разделов
section_indices <- which(desc_stats$Значение == "")

# форматирование к заголовкам разделов
for(idx in section_indices) {
  ft_desc <- ft_desc %>%
    # Объединяем ячейки для заголовка раздела
    merge_at(i = idx, j = 1:2, part = "body") %>%
    # Выравнивание по центру
    align(i = idx, align = "center", part = "body") %>%
    # Жирный шрифт
    bold(i = idx, part = "body") %>%
    # Цвет фона
    bg(i = idx, bg = "#f8f8f8", part = "body") %>%
    # Границы
    border(i = idx, 
           border.top = fp_border(color = "black", width = 1),
           border.bottom = fp_border(color = "black", width = 1),
           part = "body")
}

# Отображаем таблицу
ft_desc
```

```{r}
cat("Пропуски в данных:\n")
print(colSums(is.na(data_clean))[colSums(is.na(data_clean)) > 0])
cat("\nВсего строк с пропусками:", sum(!complete.cases(data_clean)))
```

-   В датасете не обнаружено пропущенных значений.
-   Группы сбалансированы по размеру (57 vs 57).
-   Все переменные имеют ожидаемые диапазоны значений, кроме ИМТ (есть пациенты с ожирением, ИМТ > 30), аномалий в суммарной статистике не обнаружено.

## Анализ ИМТ пациентов

Согласно критериям невключения, в КИ не должны входить пациенты с ожирением и/или метаболическим синдромом, так как эти состояния могут влиять на репродуктивную функцию и результаты лечения.

Оценим ИМТ в нашей выборке.

```{r}
# Создаем таблицу распределения по ИМТ
n_total <- nrow(data_clean)  # Сохраняем общее количество

bmi_table_data <- data_clean %>%
  mutate(
    BMI_Category = case_when(
      V1_ANT_BMI < 18.5 ~ "Недостаточный вес (<18.5)",
      V1_ANT_BMI >= 18.5 & V1_ANT_BMI < 25 ~ "Нормальный вес (18.5-24.9)",
      V1_ANT_BMI >= 25 & V1_ANT_BMI < 30 ~ "Избыточный вес (25-29.9)",
      V1_ANT_BMI >= 30 ~ "Ожирение (≥30)",
      TRUE ~ "Не определено"
    )
  ) %>%
  group_by(BMI_Category) %>%
  summarise(
    n = n(),
    Percent = round(n / n_total * 100, 1),  # Используем n_total вместо n()
    .groups = "drop"
  ) %>%
  arrange(factor(BMI_Category, levels = c(
    "Недостаточный вес (<18.5)",
    "Нормальный вес (18.5-24.9)", 
    "Избыточный вес (25-29.9)",
    "Ожирение (≥30)"
  )))

# Создаем таблицу с flextable
ft_bmi <- flextable(bmi_table_data) %>%
  fontsize(size = 10, part = "all") %>%
  font(fontname = "Times New Roman", part = "all") %>%
  align(align = "center", part = "header") %>%
  align(align = "left", j = 1) %>%
  align(align = "center", j = 2:3) %>%
  set_caption("Таблица 2. Распределение пациентов по категориям индекса массы тела (ИМТ)") %>%
  set_header_labels(
    BMI_Category = "Категория ИМТ (кг/м²)",
    n = "n",
    Percent = "%"
  ) %>%
  add_footer_row(
    top = FALSE,
    values = c("Всего пациентов", sprintf("%d", n_total), "100.0"),
    colwidths = c(1, 1, 1)
  ) %>%
  add_footer_lines("Критерии классификации ИМТ по ВОЗ: недостаточный вес (<18.5), нормальный (18.5-24.9), избыточный (25-29.9), ожирение (≥30)") %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 0.5)) %>%
  border_outer(border = fp_border(color = "black", width = 1)) %>%
  bold(part = "header") %>%
  bold(part = "footer") %>%
  bg(bg = "#f2f2f2", part = "header") %>%
  bg(i = ~ BMI_Category == "Ожирение (≥30)", bg = "#ffe6e6") %>%
  bold(i = ~ BMI_Category == "Ожирение (≥30)") %>%
  padding(padding = 4, part = "all")

# Отображаем таблицу
ft_bmi

```

**Большинство пациентов** (64.9%) имеют избыточный вес или ожирение:

-   Избыточный вес (25-29.9): 41.2%
-   Ожирение (≥30): 23.7%

**Ожирение** присутствует у 27 пациентов (23.7%), что противоречит заявленному критерию исключения исследования.

**Нормальный вес** только у 32.5% пациентов.

**Недостаточный вес** - у 3 пациентов (2.6%).

**Вывод.** В исследовании значительная доля пациентов имеет избыточную массу тела и ожирение. Это важно учитывать при анализе эффективности L-карнитина, так как ожирение может:

-   Влиять на гормональный профиль (снижение тестостерона).
-   Ухудшать параметры спермограммы.
-   Модифицировать ответ на терапию.

## Анализ соотношения ацилкарнитин/свободный L-карнитин в крови и моче у пациентов

В лабораторной диагностике первичного и вторичного дефицита карнитина используют измерение общего и свободного карнитина в плазме крови и моче с расчетом ацилкарнитина (эстерифицированного карнитина) как разницы между общим и свободным и оценки соотношения ацилкарнитина и свободного карнитина.

```{r}
# Анализ соотношения Ацилкарнитин/Свободный карнитин
ratio_analysis_corrected <- data.frame(
  Параметр = character(),
  Значение = character(),
  stringsAsFactors = FALSE
)

# Функции для добавления строк
add_header_ratio <- function(section_name) {
  ratio_analysis_corrected <<- rbind(ratio_analysis_corrected, 
                                    data.frame(Параметр = section_name,
                                               Значение = "",
                                               stringsAsFactors = FALSE))
}

add_stat_ratio <- function(parameter, value) {
  ratio_analysis_corrected <<- rbind(ratio_analysis_corrected, 
                                    data.frame(Параметр = parameter,
                                               Значение = value,
                                               stringsAsFactors = FALSE))
}

# Расчет с обработкой нулевых значений
data_clean <- data_clean %>%
  mutate(
    # КРОВЬ: Ацилкарнитин = Общий - Свободный
    Acyl_blood = V1_LCA_B_TOTAL - V1_LCA_B_FREE,
    
    # Расчет соотношения для крови (должно быть нормально)
    Ratio_acyl_free_blood = ifelse(V1_LCA_B_FREE > 0, 
                                   Acyl_blood / V1_LCA_B_FREE, 
                                   NA),
    
    # МОЧА: Ацилкарнитин = Общий - Свободный
    Acyl_urine = V1_LCA_U_TOTAL - V1_LCA_U_FREE,
    
    # Расчет соотношения для мочи с проверкой на ноль
    Ratio_acyl_free_urine = ifelse(V1_LCA_U_FREE > 0, 
                                   Acyl_urine / V1_LCA_U_FREE, 
                                   NA),
    
    # Флаги отклонений
    Abnormal_ratio_blood = case_when(
      is.na(Ratio_acyl_free_blood) ~ NA,
      Ratio_acyl_free_blood < 0.1 | Ratio_acyl_free_blood > 0.8 ~ TRUE,
      TRUE ~ FALSE
    ),
    
    Abnormal_ratio_urine = case_when(
      is.na(Ratio_acyl_free_urine) ~ NA,
      Ratio_acyl_free_urine < 0.5 | Ratio_acyl_free_urine > 7.3 ~ TRUE,
      TRUE ~ FALSE
    ),
    
    # Категории для мочи
    Ratio_urine_category = case_when(
      is.na(Ratio_acyl_free_urine) ~ "Невозможно рассчитать (свободный = 0)",
      Ratio_acyl_free_urine < 0.5 ~ "Сниженное",
      Ratio_acyl_free_urine >= 0.5 & Ratio_acyl_free_urine <= 7.3 ~ "В норме",
      Ratio_acyl_free_urine > 7.3 ~ "Повышенное",
      TRUE ~ "Не определено"
    )
  )

# Проверим, сколько пациентов имеют свободный карнитин в моче = 0
zero_free_urine <- sum(data_clean$V1_LCA_U_FREE == 0, na.rm = TRUE)

# 1. СООТНОШЕНИЕ В КРОВИ
add_header_ratio("СООТНОШЕНИЕ АЦИЛКАРНИТИН/СВОБОДНЫЙ КАРНИТИН В КРОВИ")

mean_ratio_blood <- mean(data_clean$Ratio_acyl_free_blood, na.rm = TRUE)
sd_ratio_blood <- sd(data_clean$Ratio_acyl_free_blood, na.rm = TRUE)
median_ratio_blood <- median(data_clean$Ratio_acyl_free_blood, na.rm = TRUE)

add_stat_ratio("Соотношение (среднее ± СО)", 
              sprintf("%.2f ± %.2f", mean_ratio_blood, sd_ratio_blood))
add_stat_ratio("Диапазон", sprintf("%.2f - %.2f", 
                                   min(data_clean$Ratio_acyl_free_blood, na.rm = TRUE),
                                   max(data_clean$Ratio_acyl_free_blood, na.rm = TRUE)))
add_stat_ratio("Референсные значения (Инвитро)", "0.1 - 0.8")

# Распределение для крови
blood_ratio_summary <- data_clean %>%
  filter(!is.na(Ratio_acyl_free_blood)) %>%
  mutate(
    Category = case_when(
      Ratio_acyl_free_blood < 0.1 ~ "Сниженное",
      Ratio_acyl_free_blood >= 0.1 & Ratio_acyl_free_blood <= 0.8 ~ "В норме",
      Ratio_acyl_free_blood > 0.8 ~ "Повышенное"
    )
  ) %>%
  count(Category) %>%
  mutate(Percent = n / sum(n) * 100)

for (i in 1:nrow(blood_ratio_summary)) {
  add_stat_ratio(paste("Соотношение", tolower(blood_ratio_summary$Category[i])), 
                sprintf("%d (%.1f%%)", blood_ratio_summary$n[i], blood_ratio_summary$Percent[i]))
}

# 2. СООТНОШЕНИЕ В МОЧЕ
add_header_ratio("СООТНОШЕНИЕ АЦИЛКАРНИТИН/СВОБОДНЫЙ КАРНИТИН В МОЧЕ")

# Только для пациентов с V1_LCA_U_FREE > 0
valid_urine_data <- data_clean %>% 
  filter(!is.na(Ratio_acyl_free_urine) & is.finite(Ratio_acyl_free_urine))

n_valid_urine <- nrow(valid_urine_data)

if (n_valid_urine > 0) {
  mean_ratio_urine <- mean(valid_urine_data$Ratio_acyl_free_urine, na.rm = TRUE)
  sd_ratio_urine <- sd(valid_urine_data$Ratio_acyl_free_urine, na.rm = TRUE)
  median_ratio_urine <- median(valid_urine_data$Ratio_acyl_free_urine, na.rm = TRUE)
  
  add_stat_ratio("Соотношение (среднее ± СО)", 
                sprintf("%.2f ± %.2f", mean_ratio_urine, sd_ratio_urine))
  add_stat_ratio("Диапазон", sprintf("%.2f - %.2f", 
                                     min(valid_urine_data$Ratio_acyl_free_urine, na.rm = TRUE),
                                     max(valid_urine_data$Ratio_acyl_free_urine, na.rm = TRUE)))
} else {
  add_stat_ratio("Соотношение (среднее ± СО)", "Невозможно рассчитать")
  add_stat_ratio("Невозможно рассчитать")
  add_stat_ratio("Диапазон", "Невозможно рассчитать")
}

add_stat_ratio("Референсные значения (Инвитро)", "0.5 - 7.3")

# Распределение для мочи
urine_ratio_summary <- data_clean %>%
  filter(!is.na(Ratio_urine_category)) %>%
  count(Ratio_urine_category) %>%
  mutate(Percent = n / sum(n) * 100)

for (i in 1:nrow(urine_ratio_summary)) {
  add_stat_ratio(urine_ratio_summary$Ratio_urine_category[i], 
                sprintf("%d (%.1f%%)", urine_ratio_summary$n[i], urine_ratio_summary$Percent[i]))
}

# 3. СВОДНЫЙ АНАЛИЗ
add_header_ratio("СВОДНЫЙ АНАЛИЗ МЕТАБОЛИЗМА КАРНИТИНА")

# Для крови
abnormal_blood_count <- sum(data_clean$Abnormal_ratio_blood, na.rm = TRUE)
valid_blood_count <- sum(!is.na(data_clean$Abnormal_ratio_blood))
abnormal_blood_percent <- round(abnormal_blood_count / valid_blood_count * 100, 1)

add_stat_ratio("Пациентов с отклонениями соотношения в крови", 
              sprintf("%d/%d (%.1f%%)", abnormal_blood_count, valid_blood_count, abnormal_blood_percent))

# Для мочи (только где можно рассчитать)
abnormal_urine_count <- sum(data_clean$Abnormal_ratio_urine, na.rm = TRUE)
valid_urine_count <- sum(!is.na(data_clean$Abnormal_ratio_urine))
abnormal_urine_percent <- round(abnormal_urine_count / valid_urine_count * 100, 1)

add_stat_ratio("Пациентов с отклонениями соотношения в моче (где можно рассчитать)", 
              sprintf("%d/%d (%.1f%%)", abnormal_urine_count, valid_urine_count, abnormal_urine_percent))

# Пациенты с нормальным метаболизмом в обоих показателях (где оба можно рассчитать)
normal_both <- data_clean %>%
  filter(!is.na(Abnormal_ratio_blood) & !is.na(Abnormal_ratio_urine)) %>%
  filter(!Abnormal_ratio_blood & !Abnormal_ratio_urine) %>%
  nrow()

total_both <- data_clean %>%
  filter(!is.na(Abnormal_ratio_blood) & !is.na(Abnormal_ratio_urine)) %>%
  nrow()

if (total_both > 0) {
  add_stat_ratio("Пациентов с нормальным соотношением в обоих показателях", 
                sprintf("%d/%d (%.1f%%)", normal_both, total_both, normal_both/total_both*100))
}

# Создаем таблицу с flextable
ft_ratio_corrected <- flextable(ratio_analysis_corrected) %>%
  fontsize(size = 9, part = "all") %>%
  font(fontname = "Times New Roman", part = "all") %>%
  align(align = "center", part = "header") %>%
  align(align = "left", part = "body") %>%
  align(j = 2, align = "right", part = "body") %>%
  set_caption("Таблица 3. Анализ соотношения Ацилкарнитин/Свободный карнитин") %>%
  add_footer_lines("*Соотношение рассчитывается только при свободном карнитине > 0
**У некоторых пациентов свободный карнитин в моче = 0, соотношение невозможно рассчитать") %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1)) %>%
  bold(part = "header") %>%
  bg(bg = "#f2f2f2", part = "header") %>%
  padding(padding = 4, part = "all") %>%
  width(width = c(3.5, 2))

# Применяем форматирование к заголовкам разделов
section_indices <- which(ratio_analysis_corrected$Значение == "")
for(idx in section_indices) {
  ft_ratio_corrected <- ft_ratio_corrected %>%
    merge_at(i = idx, j = 1:2, part = "body") %>%
    align(i = idx, align = "center", part = "body") %>%
    bold(i = idx, part = "body") %>%
    bg(i = idx, bg = "#f8f8f8", part = "body") %>%
    border(i = idx, 
           border.top = fp_border(color = "black", width = 1),
           border.bottom = fp_border(color = "black", width = 1),
           part = "body")
}

# Отображаем таблицу
ft_ratio_corrected
```

**В КРОВИ:**

- 53.5% пациентов (61 из 114) имеют отклонения в соотношении ацилкарнитин/свободный карнитин.

- Повышенное соотношение (>0.8): 37.7% пациентов - наиболее частая аномалия.

- Сниженное соотношение (<0.1): 15.8% пациентов.

- Среднее соотношение 0.73 - близко к верхней границе нормы (0.8).

**В МОЧЕ:**

- 34.8% пациентов (39 из 112, где возможно рассчитать) имеют отклонения от нормы.

- Преобладают сниженные значения (<0.5): 34.2%.

- Только 1.8% пациентов имеют повышенное соотношение (>7.3).

- Среднее соотношение 1.15 - в пределах референса (0.5-7.3).

Только 29.5% пациентов имеют нормальное соотношение в обоих показателях. 70.5% пациентов имеют те или иные нарушения метаболизма карнитина. 

Также обнаружены различия между кровью и мочей:

- В крови преимущественно повышенные значения (37.7% пациентов).

= В моче преимущественно сниженные значения (34.2%).


## Анализ гормонального профиля пациентов

**Референсные значения:**

*ЛГ* для мужчин старше 20 лет: 0,57 – 12,07 мМЕд/мл.
*ФСГ* для мужчин старше 21 года: 0,95 - 11,95 мМЕд/мл.
*Общий тестостерон* для мужчин 18 - 40 лет: 300 - 1080 нг/дл; для мужчин 40 - 60 лет: 300 - 890 нг/дл.

```{r}
# Создаем датафрейм с описательной статистикой и референсными значениями
desc_stats <- data.frame(
  Характеристика = character(),
  Значение = character(),
  Референсные_значения = character(),
  stringsAsFactors = FALSE
)

# Функция для добавления заголовка раздела (будет занимать 3 столбца)
add_header <- function(section_name) {
  desc_stats <<- rbind(desc_stats, 
                      data.frame(Характеристика = section_name,
                                 Значение = "",
                                 Референсные_значения = "",
                                 stringsAsFactors = FALSE))
}

# Функция для добавления строк с данными
add_stat <- function(characteristic, value, reference = "") {
  desc_stats <<- rbind(desc_stats, 
                      data.frame(Характеристика = characteristic,
                                 Значение = value,
                                 Референсные_значения = reference,
                                 stringsAsFactors = FALSE))
}

n_total <- nrow(data_clean)

# 3. ГОРМОНАЛЬНЫЙ ПРОФИЛЬ
add_header("ГОРМОНАЛЬНЫЙ ПРОФИЛЬ (ИСХОДНО, V1)")
add_stat("ФСГ, МЕ/л (среднее ± СО)", 
         sprintf("%.2f ± %.2f", mean(data_clean$V1_HOR_FSH), sd(data_clean$V1_HOR_FSH)),
         "0,95 - 11,95 мМЕд/мл")
add_stat("ЛГ, МЕ/л (среднее ± СО)", 
         sprintf("%.2f ± %.2f", mean(data_clean$V1_HOR_LH), sd(data_clean$V1_HOR_LH)),
         "0,57 - 12,07 мМЕд/мл")
add_stat("Тестостерон общий, нг/дл (среднее ± СО)", 
         sprintf("%.0f ± %.0f", mean(data_clean$V1_HOR_TT), sd(data_clean$V1_HOR_TT)),
         "300 - 1080 нг/дл (18-40 лет)")

# 3.1. ГОРМОНАЛЬНЫЙ ПРОФИЛЬ (ПОСЛЕ ЛЕЧЕНИЯ)
add_header("ГОРМОНАЛЬНЫЙ ПРОФИЛЬ (ПОСЛЕ ЛЕЧЕНИЯ, V2)")
add_stat("ФСГ, МЕ/л (среднее ± СО)", 
         sprintf("%.2f ± %.2f", mean(data_clean$V2_HOR_FSH), sd(data_clean$V2_HOR_FSH)),
         "0,95 - 11,95 мМЕд/мл")
add_stat("ЛГ, МЕ/л (среднее ± СО)", 
         sprintf("%.2f ± %.2f", mean(data_clean$V2_HOR_LH), sd(data_clean$V2_HOR_LH)),
         "0,57 - 12,07 мМЕд/мл")
add_stat("Тестостерон общий, нг/дл (среднее ± СО)", 
         sprintf("%.0f ± %.0f", mean(data_clean$V2_HOR_TT), sd(data_clean$V2_HOR_TT)),
         "300 - 1080 нг/дл (18-40 лет)")

# Создаем таблицу с flextable
ft_desc <- flextable(desc_stats) %>%
  # Настройка шрифтов и размеров
  fontsize(size = 9, part = "all") %>%
  font(fontname = "Times New Roman", part = "all") %>%
  # Выравнивание
  align(align = "center", part = "header") %>%
  align(align = "left", part = "body") %>%
  align(j = 2, align = "center", part = "body") %>%
  align(j = 3, align = "center", part = "body") %>%
  # Заголовок таблицы
  set_caption("Таблица 4. Гормональный профиль пациентов") %>%
  # Подпись
  add_footer_lines(c(
    "Примечание: V1 - исходный визит (День 1), V2 - визит после лечения (День 90)",
    "*Референсные значения приведены в соответствии с лабораторными стандартами"
  )) %>%
  # Автоподбор ширины
  autofit() %>%
  # Добавляем границы
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1)) %>%
  # Жирный шрифт для заголовков
  bold(part = "header") %>%
  # Цвет фона для заголовка таблицы
  bg(bg = "#f2f2f2", part = "header") %>%
  # отступы
  padding(padding = 4, part = "all") %>%
  # Устанавливаем ширину столбцов
  width(width = c(3.5, 2, 2.5)) %>% 
  set_header_labels(
    Референсные_значения = "Референсные значения*"  
  )

# индексы строк с заголовками разделов
section_indices <- which(desc_stats$Значение == "")

# форматирование к заголовкам разделов
for(idx in section_indices) {
  ft_desc <- ft_desc %>%
    # Объединяем ячейки для заголовка раздела
    merge_at(i = idx, j = 1:3, part = "body") %>%
    # Выравнивание по центру
    align(i = idx, align = "center", part = "body") %>%
    # Жирный шрифт
    bold(i = idx, part = "body") %>%
    # Цвет фона
    bg(i = idx, bg = "#f8f8f8", part = "body") %>%
    # Границы
    border(i = idx, 
           border.top = fp_border(color = "black", width = 1),
           border.bottom = fp_border(color = "black", width = 1),
           part = "body")
}

# Отображаем таблицу
ft_desc
```

Средние исходные уровни ФСГ (5.73 МЕ/л), ЛГ (4.64 МЕ/л) и тестостерона общего (526 нг/дл) у мужчин до терапии находятся в пределах референсных значений.

Проведенное лечение не оказало значимого влияния на уровни ФСГ, ЛГ и тестостерона:

- ФСГ: 5.73 → 5.74 МЕ/л (практически без изменений).
- ЛГ: 4.64 → 4.64 МЕ/л (стабильно).
- Тестостерон общий: 526 → 524 нг/дл (незначительное снижение на 0.4%).

<br>

# Анализ первичной конечных точек

## Определение первичной конечной точки

Первичная конечная точка: доля пациентов с нормализованной спермограммой к 90-му дню терапии (V2, День 90) по критериям ВОЗ 2010 г. по сравнению с исходным уровнем (V1, День 1).

**Критерии нормализации (все три должны выполняться одновременно):**
- Концентрация сперматозоидов ≥15 млн/мл
- Прогрессивная подвижность ≥32%
- Нормальная морфология ≥4%

```{r second_point_SEM}
# Создание бинарных переменных для нормализованной спермограммы
data_primary <- data %>%
  mutate(
    # Нормализация на исходном визите (V1)
    V1_NORMALIZED = ifelse(
      V1_SEM_CONC >= 15 & V1_SEM_PMOT >= 32 & V1_SEM_MORPH >= 4,
      1, 0
    ),
    # Нормализация на визите 2 (V2)
    V2_NORMALIZED = ifelse(
      V2_SEM_CONC >= 15 & V2_SEM_PMOT >= 32 & V2_SEM_MORPH >= 4,
      1, 0
    )
  ) %>%
  # Конвертируем в числовой формат для корректных вычислений
  mutate(
    V1_NORMALIZED = as.numeric(V1_NORMALIZED),
    V2_NORMALIZED = as.numeric(V2_NORMALIZED)
  ) 

# Описательная статистика по группам
primary_desc <- data_primary %>%
  group_by(ARM) %>%
  summarise(
    n_total = n(),
    # Исходный визит (V1)
    V1_normalized_n = sum(V1_NORMALIZED == 1),
    V1_normalized_pct = round(mean(V1_NORMALIZED == 1) * 100, 1),
    # Визит 2 (V2, 3 месяца)
    V2_normalized_n = sum(V2_NORMALIZED == 1),
    V2_normalized_pct = round(mean(V2_NORMALIZED == 1) * 100, 1),
    # Изменение
    change_n = V2_normalized_n - V1_normalized_n,
    change_pct = V2_normalized_pct - V1_normalized_pct
  )

#вспомогательный датасет для возможности переименовая строк
second_point_SEM <- primary_desc %>%
  select(ARM, n_total, V1_normalized_n, V2_normalized_n, V2_normalized_pct) %>%
  mutate(ARM = recode(
    ARM,
    "L-carnitine" = "L-карнитин",
    "Placebo" = "Плацебо")
  )
  

ft_second_point_SEM <- flextable(second_point_SEM) %>%
  set_caption(caption = "Доля пациентов с нормализованной спермограммой до и после начала терапии") %>%
  set_header_labels(
    ARM = "Группа",
    n_total = "Всего участников",
    V1_normalized_n = "Здоровые пациенты (Визит 1)",
    V1_normalized_pct = "Здоровые пациенты, % (Визит 1)",
    V2_normalized_n = "Здоровые пациенты (Визит 2)",
    V2_normalized_pct = "Здоровые пациенты, % (Визит 2)"
  ) %>%
  autofit() %>%
  theme_box() %>%
  align(align = "center", part = "all")

ft_second_point_SEM
```

```{r contingency_table_first_endpoint}
# Статистический анализ: сравнение между группами на V2
contingency_table <- table(
  data_primary$ARM, 
  factor(data_primary$V2_NORMALIZED, levels = c(0, 1), labels = c("Не нормализована", "Нормализована"))
)

# Критерий хи-квадрат
contingency_df <- as.data.frame.matrix(contingency_table) %>%
  rownames_to_column(var = "Группа") %>%
  mutate(
    Группа = recode(
      Группа,
      "L-carnitine" = "L-карнитин",
      "Placebo" = "Плацебо"
    )
  )

ft_contingency <- flextable(contingency_df) %>%
  set_caption("Таблица X. Распределение пациентов по нормализации показателя на втором визите") %>%
  set_header_labels(
    Группа = "Группа",
    `Не нормализована` = "Не нормализована",
    `Нормализована` = "Нормализована"
  ) %>%
  autofit() %>%
  theme_box() %>%
  align(align = "center", part = "all")

ft_contingency
```

```{r chi_square_first_endpoint}
chi_square_test <- chisq.test(contingency_table)
chi_value <- unname(chi_square_test$statistic)
p_value   <- chi_square_test$p.value
# Расчет относительного риска (RR) и разности долей (RD) с обработкой нулевых значений
if (nrow(contingency_table) == 2 && ncol(contingency_table) == 2) {
  row_names <- rownames(contingency_table)
  lc_row <- which(row_names == "L-carnitine")
  placebo_row <- which(row_names == "Placebo")
  
  a <- contingency_table[lc_row, 2]      # L-carnitine нормализована
  b <- contingency_table[lc_row, 1]      # L-carnitine не нормализована
  c <- contingency_table[placebo_row, 2]  # Placebo нормализована
  d <- contingency_table[placebo_row, 1] # Placebo не нормализована
  
  p1 <- a / (a + b)  # Доля в группе L-carnitine
  p2 <- c / (c + d)  # Доля в группе Placebo
  
  # Разность долей (RD) - рассчитывается всегда
  RD <- p1 - p2
  SE_RD <- sqrt((p1*(1-p1)/(a+b)) + (p2*(1-p2)/(c+d)))
  RD_CI_lower <- RD - 1.96 * SE_RD
  RD_CI_upper <- RD + 1.96 * SE_RD
  
  #cat("\nРазность долей (RD):", round(RD, 4))
  #cat("\n95% ДИ для RD: [", round(RD_CI_lower, 4), "; ", round(RD_CI_upper, 4), "]\n", sep = "")
  # Относительный риск (RR) - только если обе доли > 0
  if (a > 0 && c > 0) {
    RR <- p1 / p2
    log_RR <- log(RR)
    SE_log_RR <- sqrt((1/a) - (1/(a+b)) + (1/c) - (1/(c+d)))
    CI_lower <- exp(log_RR - 1.96 * SE_log_RR)
    CI_upper <- exp(log_RR + 1.96 * SE_log_RR)
    cat("\nОтносительный риск (RR):", round(RR, 3))
    cat("\n95% ДИ для RR: [", round(CI_lower, 3), "; ", round(CI_upper, 3), "]\n", sep = "")
  } else {
    cat("\nОтносительный риск (RR): не может быть рассчитан (нулевые значения в одной из групп)\n")
    RR <- NA
    CI_lower <- NA
    CI_upper <- NA
  }
}

chi_square_stats <- data.frame(
  Показатель = c(
    "Хи-квадрат",
    "p-значение",
    "Разность долей (RD)",
    "95% доверительный интервал для RD"
  ),
  Значение = c(
    round(chi_value, 3),
    signif(p_value, 3),
    round(RD, 3),
    paste0(
      "[",
      round(RD_CI_lower, 3), "; ",
      round(RD_CI_upper, 3),
      "]"
    )
  )
)

ft_chi_square_stats <- flextable(chi_square_stats) %>%
  set_caption("Таблица X. Сравнение частотыных переменных с помощью критерия χ²") %>%
  autofit() %>%
  theme_box() %>%
  align(align = "center", part = "all")

ft_chi_square_stats
```
В связи с низкими частотами событий в таблице сопряженности расчет отношения рисков (RR) оказался невозможен. В качестве альтернативной меры эффекта была использована разность долей

```{r}
# Подготовка данных для визуализации
viz_data <- data_primary %>%
  select(ARM, V1_NORMALIZED, V2_NORMALIZED) %>%
  pivot_longer(
    cols = c(V1_NORMALIZED, V2_NORMALIZED),
    names_to = "Visit",
    values_to = "Normalized"
  ) %>%
  mutate(
    Visit = case_when(
      Visit == "V1_NORMALIZED" ~ "Исходный визит (V1)",
      Visit == "V2_NORMALIZED" ~ "90 дней (V2)"
    ),
    Normalized = as.numeric(Normalized)
  ) %>%
  group_by(ARM, Visit) %>%
  summarise(
    n_normalized = sum(Normalized == 1),
    n_total = n(),
    pct = round(mean(Normalized == 1) * 100, 1),
    .groups = "drop"
  )

# Столбчатая диаграмма
p_primary <- ggplot(viz_data, aes(x = Visit, y = pct, fill = ARM)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  geom_text(
    aes(label = paste0(n_normalized, "\n(", pct, "%)")),
    position = position_dodge(width = 0.8),
    vjust = -0.3,
    size = 3.5
  ) +
  scale_fill_manual(
    values = c("L-carnitine" = "#4A90E2", "Placebo" = "#E24A4A"),
    name = "Группа"
  ) +
  labs(
    title = "Доля пациентов с нормализованной спермограммой",
    subtitle = "По критериям ВОЗ 2010 г. (концентрация ≥15 млн/мл, подвижность ≥32%, морфология ≥4%)",
    x = "Визит",
    y = "Доля пациентов, %"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 12, face = "bold"),
    plot.subtitle = element_text(size = 10),
    axis.text = element_text(size = 9),
    axis.title = element_text(size = 10),
    legend.position = "bottom"
  ) +
  ylim(0, max(c(viz_data$pct, 5)) * 1.2)

print(p_primary)
```

```{r}
# Создание итоговой таблицы результатов
primary_results <- data.frame(
  Параметр = character(),
  L_carnitine = character(),
  Placebo = character(),
  Статистика = character(),
  stringsAsFactors = FALSE
)

# Функция для добавления строки
add_row_result <- function(param, lc_val, placebo_val, stat = "") {
  primary_results <<- rbind(
    primary_results,
    data.frame(
      Параметр = param,
      L_carnitine = lc_val,
      Placebo = placebo_val,
      Статистика = stat,
      stringsAsFactors = FALSE
    )
  )
}

# Заголовок
add_row_result("ИТОГИ АНАЛИЗА ПЕРВИЧНОЙ КОНЕЧНОЙ ТОЧКИ", "", "", "")

# Исходный визит (V1)
lc_v1 <- primary_desc %>% filter(ARM == "L-carnitine")
placebo_v1 <- primary_desc %>% filter(ARM == "Placebo")

add_row_result("ИСХОДНЫЙ ВИЗИТ (V1, День 1)", "", "", "")
add_row_result(
  "Пациенты с нормализованной спермограммой",
  sprintf("%d (%.1f%%)", lc_v1$V1_normalized_n, lc_v1$V1_normalized_pct),
  sprintf("%d (%.1f%%)", placebo_v1$V1_normalized_n, placebo_v1$V1_normalized_pct),
  ""
)

# Визит 2 (V2)
add_row_result("ВИЗИТ 2 (V2, День 90)", "", "", "")
add_row_result(
  "Пациенты с нормализованной спермограммой",
  sprintf("%d (%.1f%%)", lc_v1$V2_normalized_n, lc_v1$V2_normalized_pct),
  sprintf("%d (%.1f%%)", placebo_v1$V2_normalized_n, placebo_v1$V2_normalized_pct),
  ""
)

# Изменение
add_row_result("ИЗМЕНЕНИЕ (V2 - V1)", "", "", "")
add_row_result(
  "Изменение количества пациентов",
  sprintf("%+d", lc_v1$change_n),
  sprintf("%+d", placebo_v1$change_n),
  ""
)
add_row_result(
  "Изменение доли, %",
  sprintf("%+.1f%%", lc_v1$change_pct),
  sprintf("%+.1f%%", placebo_v1$change_pct),
  ""
)

# Статистический анализ между группами на V2
add_row_result("СТАТИСТИЧЕСКОЕ СРАВНЕНИЕ МЕЖДУ ГРУППАМИ (V2)", "", "", "")
add_row_result(
  "Критерий хи-квадрат, p-value",
  "",
  "",
  sprintf("%.4f", chi_square_test$p.value)
)
add_row_result(
  "Разность долей (RD), 95% ДИ",
  "",
  "",
  sprintf("%.4f [%.4f; %.4f]", RD, RD_CI_lower, RD_CI_upper)
)
if (exists("RR") && !is.na(RR)) {
  add_row_result(
    "Относительный риск (RR), 95% ДИ",
    "",
    "",
    sprintf("%.3f [%.3f; %.3f]", RR, CI_lower, CI_upper)
  )
} else {
  add_row_result(
    "Относительный риск (RR), 95% ДИ",
    "",
    "",
    "Не может быть рассчитан"
  )
}

# Создание таблицы с flextable
ft_primary <- flextable(primary_results) %>%
  fontsize(size = 9, part = "all") %>%
  font(fontname = "Times New Roman", part = "all") %>%
  align(align = "left", part = "body") %>%
  align(align = "center", part = "header") %>%
  align(j = 2:4, align = "center", part = "body") %>%
  set_caption("Таблица 2. Анализ первичной конечной точки: доля пациентов с нормализованной спермограммой") %>%
  add_footer_lines("Примечание: Нормализация по критериям ВОЗ 2010 г.: концентрация ≥15 млн/мл, прогрессивная подвижность ≥32%, нормальная морфология ≥4%. Все три критерия должны выполняться одновременно. RD - разность долей, RR - относительный риск, ДИ - доверительный интервал. При нулевых значениях в одной из групп RR не может быть рассчитан.") %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1)) %>%
  bold(part = "header") %>%
  bg(bg = "#f2f2f2", part = "header") %>%
  padding(padding = 4, part = "all")

# Форматирование заголовков разделов
section_rows <- which(primary_results$L_carnitine == "" & primary_results$Placebo == "" & primary_results$Статистика == "")
for(idx in section_rows) {
  ft_primary <- ft_primary %>%
    merge_at(i = idx, j = 1:4, part = "body") %>%
    align(i = idx, align = "center", part = "body") %>%
    bold(i = idx, part = "body") %>%
    bg(i = idx, bg = "#f8f8f8", part = "body") %>%
    border(i = idx, 
           border.top = fp_border(color = "black", width = 1),
           border.bottom = fp_border(color = "black", width = 1),
           part = "body")
}

ft_primary
?fisher.test
```
### Интерпретация результатов первичной конечной точки

Анализ первичной конечной точки показал, что доля пациентов с нормализованной спермограммой к 90-му дню терапии (визит V2) была крайне низкой в обеих группах исследования. 

На исходном визите (V1) нормализованная спермограмма по критериям ВОЗ 2010 г. (концентрация ≥15 млн/мл, прогрессивная подвижность ≥32%, нормальная морфология ≥4%) была зарегистрирована у 0 пациентов (0,0%) в группе L-карнитина и у 1 пациента (1,8%) в группе плацебо. К моменту завершения исследования (V2, День 90) показатели остались без изменений: в группе L-карнитина — 0 пациентов (0,0%), в группе плацебо — 1 пациент (1,8%). Изменение доли пациентов с нормализованной спермограммой от исходного уровня составило 0,0% в обеих группах.

Статистическое сравнение между группами на визите V2 не выявило статистически значимых различий: точный критерий Фишера (p = 1,0000) и критерий хи-квадрат (p = 1,0000) показали отсутствие статистически значимой разницы между группами. Разность долей (RD) составила -0,0175 (95% ДИ: -0,0516; 0,0165), что также указывает на отсутствие значимого различия между группами. Относительный риск (RR) не может быть рассчитан в связи с нулевыми значениями в группе L-карнитина.

Полученные результаты свидетельствуют о том, что применение L-карнитина в течение 90 дней не привело к статистически значимому увеличению доли пациентов с нормализованной спермограммой по сравнению с группой плацебо. Низкая частота нормализации в обеих группах может быть связана с тяжестью исходных нарушений сперматогенеза у включенных в исследование пациентов, а также с необходимостью более длительного периода терапии для достижения клинически значимого эффекта.

<br>

# Анализ вторичных конечных точек

## Среднее изменение количественных параметров спермы (концентрации сперматозоидов (млн/мл), прогрессивной подвижности (%) и нормальной морфологии (%)) от исходного уровня к завершению исследования

Для оценки влияния приема препарата (L-карнитин) на динамику параметров спермограммы (концентрации сперматозоидов (млн/мл), прогрессивная подвижность (%) и нормальная морфология (%)) был проведен смешанный дисперсионный анализ (Mixed ANOVA) с факторами "Группа" (Терапия L-карнитином против Плацебо) и "Время" (Визит 1 против Визит 2).

```{r anova_SEM_CONC}
data_SEM_CONC <- data %>%
  pivot_longer(
    cols = c(V1_SEM_CONC, V2_SEM_CONC),
    names_to = "time",
    values_to = "SEM_CONC"
  ) %>%
  mutate(time = str_replace(time, "_SEM_CONC", "")) %>%  
  mutate(time = factor(time, levels = c("V1", "V2")))

SEM_CONC_changes_comparison_anova <- anova_test(
  data = data_SEM_CONC,
  dv = SEM_CONC,
  wid = USUBJID,
  between = ARM, 
  within = time
) %>%
  as_tibble() %>%
  select(Effect, `F`, "p")  %>%
  mutate(Effect = recode(
    Effect,
    ARM = "Терапия",
    time = "Время",
    "ARM:time" = "Терапия:Время")
  )

ft_SEM_CONC_changes_comparison_anova <- SEM_CONC_changes_comparison_anova %>%
  mutate(
    `F` = round(`F`, 2),
    `p` = round(`p`, 4)
  ) %>%
  flextable() %>%
  set_caption(caption = "ANOVA: факторы \"Группа терапии\" и \"Время\",\n переменная \"Концентрация сперматозоидов (млн-мл)\"") %>%
  autofit() %>% 
  set_header_labels(
    values = list(
      Effect = "Фактор",
      `F` = "F-статистика",
      `p`= "p-значение"
    )
  ) %>%
  bold(part = "header")  %>%
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body")   

ft_SEM_CONC_changes_comparison_anova
```

Статистически значимого влияния группы, времени и их взаимодействия на "Концентрацию сперматозоидов (млн-мл)" не выявлено ($p = 0.087$). Размеры эффектов были пренебрежимо малы. 

```{r anova_SEM_PMOT}
data_SEM_PMOT <- data %>%
  pivot_longer(
    cols = c(V1_SEM_PMOT, V2_SEM_PMOT),
    names_to = "time",
    values_to = "SEM_PMOT"
  ) %>%
  mutate(time = str_replace(time, "_SEM_PMOT", "")) %>%  
  mutate(time = factor(time, levels = c("V1", "V2")))

SEM_PMOT_changes_comparison_anova <- anova_test(
  data = data_SEM_PMOT,
  dv = SEM_PMOT,
  wid = USUBJID,
  between = ARM, 
  within = time
) %>%
  as_tibble() %>%
  select(Effect, `F`, "p")  %>%
  mutate(Effect = recode(
    Effect,
    ARM = "Терапия",
    time = "Время",
    "ARM:time" = "Терапия:Время")
  )

ft_SEM_PMOT_changes_comparison_anova <- SEM_PMOT_changes_comparison_anova %>%
  mutate(
    `F` = round(`F`, 2),
    `p` = round(`p`, 4)
  ) %>%
  flextable() %>%
  set_caption(caption = "ANOVA: факторы \"Группа терапии\" и \"Время\",\n переменная \"Прогрессивная подвижность (%)\"") %>%
  autofit() %>% 
  set_header_labels(
    values = list(
      Effect = "Фактор",
      `F` = "F-статистика",
      `p`= "p-значение"
    )
  ) %>%
  bold(part = "header")  %>%
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body")   

ft_SEM_PMOT_changes_comparison_anova
```
Статистически значимого влияния группы, времени и их взаимодействия на "Прогрессивная подвижность (%)" не выявлено ($p = 0.329$). Размеры эффектов были пренебрежимо малы.

```{r anova_SEM_MORPH}
data_SEM_MORPH <- data %>%
  pivot_longer(
    cols = c(V1_SEM_MORPH, V2_SEM_MORPH),
    names_to = "time",
    values_to = "SEM_MORPH"
  ) %>%
  mutate(time = str_replace(time, "_SEM_MORPH", "")) %>%  
  mutate(time = factor(time, levels = c("V1", "V2")))

SEM_MORPH_changes_comparison_anova <- anova_test(
  data = data_SEM_MORPH,
  dv = SEM_MORPH,
  wid = USUBJID,
  between = ARM, 
  within = time
  ) %>%
  as_tibble() %>%
  select(Effect, `F`, "p")  %>%
  mutate(Effect = recode(
    Effect,
    ARM = "Терапия",
    time = "Время",
    "ARM:time" = "Терапия:Время")
  )

ft_SEM_MORPH_changes_comparison_anova <- SEM_MORPH_changes_comparison_anova %>%
  mutate(
    `F` = round(`F`, 2),
    `p` = round(`p`, 4)
  ) %>%
  flextable() %>%
  set_caption(caption = "ANOVA: факторы \"Группа терапии\" и \"Время\",\n переменная \"Нормальная морфология (%)\"") %>%
  autofit() %>% 
  set_header_labels(
    values = list(
      Effect = "Фактор",
      `F` = "F-статистика",
      `p`= "p-значение"
    )
  ) %>%
  bold(part = "header")  %>%
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body")   

ft_SEM_MORPH_changes_comparison_anova
```
Первичный анализ (Таблица ANOVA) выявил статистически значимое взаимодействие факторов Группа × Время ($F(1, 112) = 9.16 , p = 0.003$). Это указывает на то, что изменение показателя морфологии во времени достоверно различалось между группой, принимавшей L-карнитин, и группой плацебо.  Также статистически значимым оказался межгрупповой эффект терапии ($p = 0.03$).  Поскольку анализ показал отсутствие общего основного эффекта времени ($p = 0.84$), то был проведен дополнительно t-тест для оценки различий между группами на первом визите (день 0).

```{r day_1_SEM_MORPH}
SEM_MORPH_t_test <- data_SEM_MORPH %>%
  filter(time == "V1") %>%
  t_test(SEM_MORPH ~ ARM) %>%
  select(`.y.`, `p`) %>%
  mutate(`.y.` = recode(
    `.y.`,
    SEM_MORPH = "Нормальная морфология (%)")
  )

ft_SEM_MORPH_t_test<- SEM_MORPH_t_test %>%
  mutate(
    `p` = round(`p`, 4)
  ) %>%
  flextable() %>%
  set_caption(caption = "t-тест: факторы \"Нормальная морфология (%)\" ~ \"Группа терапии\", визит 1 (день 0)") %>%
  autofit() %>% 
  set_header_labels(
    values = list(
      `.y.` = "Признак",
      `p`= "p-значение"
    )
  ) %>%
  bold(part = "header")  %>%
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body")   

ft_SEM_MORPH_t_test
```
Однако проверка исходной сопоставимости групп (t-тест для Визита 1) показала наличие статистически значимых различий до начала терапии ($p = 0.02$). Поскольку исходная неоднородность выборки может искажать результаты ANOVA, за счет эффекта регрессии к среднему, для верификации эффективности препарата был применен ковариационный анализ (ANCOVA). Данный метод позволяет оценить влияние терапии на конечный результат (Визит 2), математически нивелируя разницу в исходных показателях (Визит 1).

```{r ancova_SEM_MORPH}
SEM_MORPH_changes_comparison_ancova <- lm(V2_SEM_MORPH ~ ARM + V1_SEM_MORPH, data = data) %>%
  tidy(conf.int = TRUE,
       conf.level = 0.95
       ) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  mutate(
    estimate = round(estimate, 2),
    conf.low  = round(conf.low, 2),
    conf.high = round(conf.high, 2),
    p.value = round(p.value, 4),
    term = recode(
      term,
      `(Intercept)` = "Константа",
      ARMPlacebo = "Терапия",
      V1_SEM_MORPH = "Нормальная морфология (%), визит 1"
    )
  ) %>%
  filter(term == "Терапия")

r2_value <- glance(SEM_MORPH_changes_comparison_ancova$r.squared) %>%
  round(3)

ft_SEM_MORPH_changes_comparison_ancova <- flextable(SEM_MORPH_changes_comparison_ancova) %>%
  set_caption(
    paste0(
      "ANCOVA: влияние терапии на V2 SEM_MORPH (R² = ", r2_value, ")"
    )
  ) %>%
  set_header_labels(
    term = "Предиктор",
    estimate = "Оценка (β)",
    p.value = "p-значение",
    conf.low = "Верхняя граница 95% ДИ",
    conf.high = "Нижняя граница 95% ДИ"
  ) %>%
  bold(part = "header") %>%
  align(align = "center", part = "all") %>%
  autofit()

ft_SEM_MORPH_changes_comparison_ancova
```
Модель продемонстрировала высокую точность аппроксимации ($R^2 = 0.99, p < 0.001$), что свидетельствует о сильной зависимости итоговых значений морфологии от исходного уровня пациента. Важно, что даже после жесткой коррекции на исходный уровень фактор терапии сохранил высокую статистическую значимость ($p = 0.003$). Расчетные коэффициенты модели ($Терапия = -0.11$) показывают, что при условии равного старта группа Плацебо демонстрирует результат статистически значимо ниже, чем группа L-карнитина. 95% доверительный интервал для коэффициента терапии составил −0.18;−0.04 и не включает ноль, что подтверждает статистическую значимость выявленного эффекта..

Наблюдаемое улучшение показателей в группе терапии не является артефактом исходных различий. Прием L-карнитина оказывает самостоятельный, статистически подтвержденный положительный эффект на процент нормальной морфологии сперматозоидов по сравнению с плацебо. Однако, интерпретируя полученные результаты, необходимо учитывать величину наблюдаемого эффекта. Диапазон значений нормальной морфологии в анализируемой выборке варьировал от 0.1% до 9.5%, а расчетное преимущество группы терапии составило всего 0.11 процентных пункта. Несмотря на высокую статистическую достоверность ($p = 0.003$), клиническая значимость такого малого прироста требует дополнительной оценки профильным специалистом, так как столь незначительные изменения могут не оказывать существенного влияния на фертильный потенциал в соответствии с критериями ВОЗ (нижняя граница нормы — 4%).

<br>

## Гормональный профиль и биохимические маркеры (тестостерон, ФСГ, ЛГ).

```{r anova_HOR_FSH}
data_HOR_FSH <- data %>%
  pivot_longer(
    cols = c(V1_HOR_FSH, V2_HOR_FSH),
    names_to = "time",
    values_to = "HOR_FSH"
  ) %>%
  mutate(time = str_replace(time, "_HOR_FSH", "")) %>%  
  mutate(time = factor(time, levels = c("V1", "V2")))

HOR_FSH_anova <- anova_test(
  data = data_HOR_FSH,
  dv = HOR_FSH,
  wid = USUBJID,
  between = ARM, 
  within = time
) %>%
  as_tibble() %>%
  select(Effect, `F`, "p")  %>%
  mutate(Effect = recode(
    Effect,
    ARM = "Терапия",
    time = "Время",
    "ARM:time" = "Терапия:Время")
  )

ft_HOR_FSH_anova <- HOR_FSH_anova %>%
  mutate(
    `F` = round(`F`, 2),
    `p` = round(`p`, 4)
  ) %>%
  flextable() %>%
  set_caption(caption = "ANOVA: факторы \"Группа терапии\" и \"Время\",\n переменная \"Фолликуло-стимулирующий гормон (МЕ/Л)\"") %>%
  autofit() %>% 
  set_header_labels(
    values = list(
      Effect = "Фактор",
      `F` = "F-статистика",
      `p`= "p-значение"
    )
  ) %>%
  bold(part = "header")  %>%
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body")   

ft_HOR_FSH_anova
```

Статистически значимого влияния группы, времени и их взаимодействия на "Фолликуло-стимулирующий гормон (МЕ/Л)" не выявлено ($p = 0.332$). Размеры эффектов были пренебрежимо малы.

```{r anova_HOR_LH}
data_HOR_LH <- data %>%
  pivot_longer(
    cols = c(V1_HOR_LH, V2_HOR_LH),
    names_to = "time",
    values_to = "HOR_LH"
  ) %>%
  mutate(time = str_replace(time, "_HOR_LH", "")) %>%  
  mutate(time = factor(time, levels = c("V1", "V2")))

HOR_LH_anova <- anova_test(
  data = data_HOR_LH,
  dv = HOR_LH,
  wid = USUBJID,
  between = ARM, 
  within = time
) %>%
  as_tibble() %>%
  select(Effect, `F`, "p")  %>%
  mutate(Effect = recode(
    Effect,
    ARM = "Терапия",
    time = "Время",
    "ARM:time" = "Терапия:Время")
  )

ft_HOR_LH_anova <- HOR_LH_anova %>%
  mutate(
    `F` = round(`F`, 2),
    `p` = round(`p`, 4)
  ) %>%
  flextable() %>%
  set_caption(caption = "ANOVA: факторы \"Группа терапии\" и \"Время\",\n переменная \"Лютеинизирующий гормон (МЕ/Л)\"") %>%
  autofit() %>% 
  set_header_labels(
    values = list(
      Effect = "Фактор",
      `F` = "F-статистика",
      `p`= "p-значение"
    )
  ) %>%
  bold(part = "header")  %>%
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body")   

ft_HOR_LH_anova
```

Статистически значимого влияния группы, времени и их взаимодействия на "Лютеинизирующий гормон (МЕ/Л)" не выявлено ($p = 0.48$). Размеры эффектов были пренебрежимо малы.

```{r anova_HOR_TT}
data_HOR_TT <- data %>%
  pivot_longer(
    cols = c(V1_HOR_TT, V2_HOR_TT),
    names_to = "time",
    values_to = "HOR_TT"
  ) %>%
  mutate(time = str_replace(time, "_HOR_TT", "")) %>%  
  mutate(time = factor(time, levels = c("V1", "V2")))

HOR_TT_anova <- anova_test(
  data = data_HOR_TT,
  dv = HOR_TT,
  wid = USUBJID,
  between = ARM, 
  within = time
) %>%
  as_tibble() %>%
  select(Effect, `F`, "p")  %>%
  mutate(Effect = recode(
    Effect,
    ARM = "Терапия",
    time = "Время",
    "ARM:time" = "Терапия:Время")
  )

ft_HOR_TT_anova <- HOR_TT_anova %>%
  mutate(
    `F` = round(`F`, 2),
    `p` = round(`p`, 4)
  ) %>%
  flextable() %>%
  set_caption(caption = "ANOVA: факторы \"Группа терапии\" и \"Время\",\n переменная \"Обший тестостерон (МЕ/Л)\"") %>%
  autofit() %>% 
  set_header_labels(
    values = list(
      Effect = "Фактор",
      `F` = "F-статистика",
      `p`= "p-значение"
    )
  ) %>%
  bold(part = "header")  %>%
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body")   

ft_HOR_TT_anova
```
Статистически значимого влияния группы, времени и их взаимодействия на "Обший тестостерон (МЕ/Л)" не выявлено ($p = 0.15$). Размеры эффектов были пренебрежимо малы.

<br>

## Суммарная антиоксидантная способность семенной плазмы (ммоль/л).

```{r anova_TAC_TAC}
data_TAC_TAC <- data %>%
  pivot_longer(
    cols = c(V1_TAC_TAC, V2_TAC_TAC),
    names_to = "time",
    values_to = "TAC_TAC"
  ) %>%
  mutate(time = str_replace(time, "_TAC_TAC", "")) %>%  
  mutate(time = factor(time, levels = c("V1", "V2")))

TAC_TAC_anova <- anova_test(
  data = data_TAC_TAC,
  dv = TAC_TAC,
  wid = USUBJID,
  between = ARM, 
  within = time
) %>%
  as_tibble() %>%
  select(Effect, `F`, "p")  %>%
  mutate(Effect = recode(
    Effect,
    ARM = "Терапия",
    time = "Время",
    "ARM:time" = "Терапия:Время")
  )

ft_TAC_TAC_anova <- TAC_TAC_anova %>%
  mutate(
    `F` = round(`F`, 2),
    `p` = round(`p`, 4)
  ) %>%
  flextable() %>%
  set_caption(caption = "ANOVA: факторы \"Группа терапии\" и \"Время\",\n переменная \"Суммарная антиоксидантная способность семенной плазмы (a.u.)\"") %>%
  autofit() %>% 
  set_header_labels(
    values = list(
      Effect = "Фактор",
      `F` = "F-статистика",
      `p`= "p-значение"
    )
  ) %>%
  bold(part = "header")  %>%
  align(align = "center", part = "header") %>%
  align(align = "center", part = "body")   

ft_TAC_TAC_anova
```
Статистически значимого влияния группы, времени и их взаимодействия на "Обший тестостерон (МЕ/Л)" не выявлено ($p = 0.623$). Размеры эффектов были пренебрежимо малы.

<br>

# Анализ параметров безопасности

<br>

``` {r safety anomalies}
chisq_row <- function(data, arm_col, outcome_col,
                      outcome_labels = c("0"="Нет отклонений", "1"="Есть отклонения"),
                      test_label = NULL) {
  arm <- data[[arm_col]]
  y   <- data[[outcome_col]]

  tab <- table(arm, y)

  if (ncol(tab) == 2) {
    colnames(tab) <- unname(outcome_labels)
  }

  res <- suppressWarnings(chisq.test(tab))

  min_exp <- suppressWarnings(min(res$expected))
  warn <- if (any(res$expected < 5)) "есть expected < 5" else ""

  tibble(
    Endpoint = ifelse(is.null(test_label), outcome_col, test_label),
    N = sum(tab),
    Statistic = round(unname(res$statistic), 3),
    df = unname(res$parameter),
    p_value = signif(res$p.value, 3),
  )
}

endpoints <- c(
  V2_VIT_HR_ABN   = "Отклонения ЧСС от нормы",
  V2_VIT_RR_ABN   = "Отклонения ЧДД от нормы",
  V2_VIT_BP_ABN   = "Отклонения АД от нормы",
  V2_VIT_TEMP_ABN = "Отклонения температуры тела от нормы"
)

summary_df <- imap_dfr(
  endpoints,
  ~ chisq_row(
      data = data_primary,
      arm_col = "ARM",
      outcome_col = .y,  # имя элемента = имя колонки
      test_label = .x     # значение элемента = подпись
    )
)

ft <- flextable(summary_df) %>%
  set_caption("Частота отклонений жизненных показателей на конец исследовния(χ²)") %>%
  set_header_labels(
    Endpoint = "Показатель",
    N = "N",
    Statistic = "Статистика χ²",
    df = "df",
    p_value = "p-значение",
    min_expected = "min expected",
    note = "примечание"
  ) %>%
  bold(part = "header") %>%
  autofit()

ft
```


```{r}
wilson_ci <- function(x, n, conf.level = 0.95) {
  if (n == 0) return(c(NA, NA))
  z <- qnorm(1 - (1 - conf.level)/2)
  p <- x / n
  denom <- 1 + z^2 / n
  center <- (p + z^2/(2*n)) / denom
  half <- (z * sqrt((p*(1-p) + z^2/(4*n)) / n)) / denom
  c(center - half, center + half)
}

rd_newcombe <- function(a, b, c, d, conf.level = 0.95) {

  n1 <- a + b
  n0 <- c + d
  p1 <- if (n1 > 0) a/n1 else NA
  p0 <- if (n0 > 0) c/n0 else NA
  ci1 <- wilson_ci(a, n1, conf.level)
  ci0 <- wilson_ci(c, n0, conf.level)
  rd <- p1 - p0
  lo <- ci1[1] - ci0[2]
  hi <- ci1[2] - ci0[1]
  c(est = rd, lo = lo, hi = hi)
}

rr_log_ci <- function(a, b, c, d, conf.level = 0.95) {
  n1 <- a + b
  n0 <- c + d
  p1 <- a/n1
  p0 <- c/n0
  rr <- p1 / p0
  z <- qnorm(1 - (1 - conf.level)/2)
  se <- sqrt( (1/a) - (1/n1) + (1/c) - (1/n0) )
  lo <- exp(log(rr) - z*se)
  hi <- exp(log(rr) + z*se)
  c(est = rr, lo = lo, hi = hi)
}

fmt_ci <- function(est, lo, hi, digits = 4) {
  paste0(
    formatC(est, format = "f", digits = digits),
    " [",
    formatC(lo,  format = "f", digits = digits),
    "; ",
    formatC(hi,  format = "f", digits = digits),
    "]"
  )
}


chisq_rd_rr_block <- function(data, arm_col, outcome_col,
                              endpoint_label = outcome_col,
                              level_treat = NULL, level_control = NULL,
                              conf.level = 0.95) {

  arm <- factor(data[[arm_col]])
  y <- data[[outcome_col]]

  y <- factor(y, levels = c(0, 1))

  tab <- table(arm, y)

  lv <- rownames(tab)

  if (is.null(level_control)) level_control <- lv[1]
  if (is.null(level_treat))   level_treat   <- lv[2]

    tab2 <- tab[c(level_treat, level_control), , drop = FALSE]

  a <- as.numeric(tab2[1, "1"])
  b <- as.numeric(tab2[1, "0"])
  c <- as.numeric(tab2[2, "1"])
  d <- as.numeric(tab2[2, "0"])

  chisq_res <- suppressWarnings(chisq.test(tab))
  p_chisq <- chisq_res$p.value
  chisq_stat = chisq_res$statistic

  # RD
  rd <- rd_newcombe(a, b, c, d, conf.level = conf.level)
  rd_txt <- fmt_ci(rd["est"], rd["lo"], rd["hi"], digits = 4)

  rr_txt <- "Не может быть рассчитан"
  if (a > 0 && c > 0) {
    rr <- rr_log_ci(a, b, c, d, conf.level = conf.level)
    rr_txt <- fmt_ci(rr["est"], rr["lo"], rr["hi"], digits = 4)
  }

  tibble(
    Endpoint = endpoint_label,
    Metric = c("Критерий χ², p-value",
               "Критерий χ², статистика",
               "Разность долей (RD), 95% ДИ",
               "Относительный риск (RR), 95% ДИ"),
    Value = c(formatC(p_chisq, digits = 4, format = "f"),
              formatC(chisq_stat, digits = 4, format = "f"),
              rd_txt,
              rr_txt)
  )
}

endpoints <- c(
  V2_VIT_HR_ABN   = "Отклонения ЧСС от нормы",
  V2_VIT_RR_ABN   = "Отклонения ЧДД от нормы",
  V2_VIT_BP_ABN   = "Отклонения АД от нормы",
  V2_VIT_TEMP_ABN = "Отклонения температуры тела от нормы"
)

blocks_df <- imap_dfr(
  endpoints,
  ~ chisq_rd_rr_block(
      data = data_primary,
      arm_col = "ARM",
      outcome_col = .y,
      endpoint_label = .x
    )
)

ft <- flextable(blocks_df) %>%
  set_caption("Статистическое сравнение параметров безопасности\nмежду группами (V2)") %>%
  set_header_labels(
    Endpoint = "",
    Metric = "",
    Value = ""
  ) %>%
  merge_v(j = "Endpoint") %>%
  valign(j = "Endpoint", valign = "top") %>%
  bold(part = "header") %>%
  autofit()

ft
```


```{r poisson modeling_for_future}

data_primary$V1_VIT_SUM_ABN = data_primary %>% 
  select(V1_VIT_HR_ABN, 
         V1_VIT_RR_ABN,
         V1_VIT_BP_ABN,
         V1_VIT_TEMP_ABN) %>% 
  sum()

data_primary$V2_VIT_SUM_ABN = data_primary %>% 
  select(V2_VIT_HR_ABN, 
         V2_VIT_RR_ABN,
         V2_VIT_BP_ABN,
         V2_VIT_TEMP_ABN) %>% 
  sum()

abn_fit = glm(V2_VIT_SUM_ABN ~ ARM + V1_VIT_SUM_ABN, family=poisson, data=data_primary)
#abn_fit

dispersion <- sum(residuals(abn_fit, type = "pearson")^2) /
              abn_fit$df.residual
#dispersion

#pois_summary <- tibble(
#  Endpoint = "Общая нагрузка AE (сумма отклонений)",
#  Model = "Poisson regression",
#  IRR = exp(coef(abn_fit))["ARMTreatment"],
#  CI_low = exp(confint(abn_fit))["ARMTreatment", 1],
#  CI_high = exp(confint(abn_fit))["ARMTreatment", 2],
#  p_value = pois_robust["ARMTreatment", "Pr(>|z|)"]
#)

```

